<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Equip">
<meta name="theme-color" content="#0d1f33">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>Equip Booking System</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOKENS & RESET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --navy:        #0d2136;
  --navy-light:  #1a3550;
  --gold:        #a8935a;
  --soft-gold:   #d6cab0;
  --beige:       #d8d0c6;
  --lt-beige:    #e6e1da;
  --cream:       #f4f2ef;
  --grey:        #d3d6d9;
  --blue-grey:   #8a949e;
  --green:       #81845a;
  --dk-green:    #2f3527;
  --teal:        #004551;
  --dk-teal:     #002937;
  --plum:        #7e2138;
  --dk-plum:     #512137;
  --white:       #ffffff;
  --danger:      #c0392b;
  --shadow-sm:   0 2px 12px rgba(13,33,54,.08);
  --shadow-md:   0 8px 32px rgba(13,33,54,.14);
  --shadow-lg:   0 24px 60px rgba(13,33,54,.22);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;font-family:'Libre Franklin',sans-serif;color:var(--navy);background:var(--cream);}
h1,h2,h3,h4,h5,.serif{font-family:'Georgia',serif;font-weight:normal;}
button{cursor:pointer;font-family:'Libre Franklin',sans-serif;transition:all .18s ease;}
button:active{transform:scale(.97);}
input,select,textarea{font-family:'Libre Franklin',sans-serif;color:var(--navy);}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--lt-beige);}
::-webkit-scrollbar-thumb{background:var(--soft-gold);border-radius:4px;}

/* ‚îÄ‚îÄ‚îÄ SCREEN MANAGEMENT + ANIMATIONS ‚îÄ‚îÄ‚îÄ */
.screen{display:none;position:fixed;inset:0;z-index:100;}
.screen.active{display:flex;}

.screen.slide-in-right { animation: slideInRight 0.45s cubic-bezier(.22,.68,0,1.2) forwards; }
.screen.slide-in-left  { animation: slideInLeft  0.45s cubic-bezier(.22,.68,0,1.2) forwards; }
.screen.slide-out-left { animation: slideOutLeft 0.35s cubic-bezier(.4,0,1,1) forwards; }
.screen.slide-out-right{ animation: slideOutRight 0.35s cubic-bezier(.4,0,1,1) forwards; }
.screen.fade-up        { animation: fadeUp 0.5s cubic-bezier(.22,.68,0,1.1) forwards; }

@keyframes slideInRight { from{opacity:0;transform:translateX(60px)} to{opacity:1;transform:translateX(0)} }
@keyframes slideInLeft  { from{opacity:0;transform:translateX(-60px)} to{opacity:1;transform:translateX(0)} }
@keyframes slideOutLeft { from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(-60px)} }
@keyframes slideOutRight{ from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(60px)} }
@keyframes fadeUp       { from{opacity:0;transform:translateY(40px)} to{opacity:1;transform:translateY(0)} }

#loading-screen{background:linear-gradient(135deg,var(--navy),var(--dk-teal));align-items:center;justify-content:center;flex-direction:column;gap:20px;}
.spinner{width:44px;height:44px;border:3px solid rgba(168,147,90,.3);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:var(--soft-gold);font-size:13px;letter-spacing:3px;text-transform:uppercase;}

.btn-ripple{position:relative;overflow:hidden;}
.btn-ripple::after{content:'';position:absolute;width:100px;height:100px;background:rgba(255,255,255,.25);border-radius:50%;transform:scale(0);opacity:1;pointer-events:none;}
.btn-ripple.rippling::after{animation:ripple .5s ease-out forwards;}
@keyframes ripple{to{transform:scale(4);opacity:0;}}

.panel-fade { animation: panelFade 0.4s cubic-bezier(.22,.68,0,1.1); }
@keyframes panelFade { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

.overlay{position:fixed;inset:0;background:rgba(13,33,54,.6);backdrop-filter:blur(6px);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;
  opacity:0;transition:opacity .35s ease;}
.overlay.open{opacity:1;}
.overlay .modal{transform:translateY(24px) scale(.97);transition:transform .4s cubic-bezier(.22,.68,0,1.2);}
.overlay.open .modal{transform:translateY(0) scale(1);}

.bk-chip { animation: chipIn .2s ease; }
@keyframes chipIn { from{opacity:0;transform:scaleY(.7)} to{opacity:1;transform:scaleY(1)} }

@keyframes notifIn  { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes notifOut { from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(20px)} }

/* Shake animation for failed login */
@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-10px)}
  40%{transform:translateX(10px)}
  60%{transform:translateX(-8px)}
  80%{transform:translateX(8px)}
}
.shake { animation: shake .35s ease; }

.month-cell { transition: background .2s ease; }
.mini-cal   { transition: all .25s cubic-bezier(.22,.68,0,1.2); }
.user-option{ transition: all .2s cubic-bezier(.22,.68,0,1.2); }
.portal-card{ transition: all .35s cubic-bezier(.22,.68,0,1.2); }
.nav-item { transition: all .2s cubic-bezier(.22,.68,0,1.2); }
.res-tab  { transition: all .22s ease; }
.view-tab { transition: all .22s ease; }

/* ‚îÄ‚îÄ‚îÄ PORTAL SELECTION ‚îÄ‚îÄ‚îÄ */
#portal-screen{background:linear-gradient(145deg,var(--navy) 0%,var(--dk-teal) 60%,var(--dk-plum) 100%);align-items:center;justify-content:center;flex-direction:column;overflow-y:auto;}
.portal-deco{position:absolute;border-radius:50%;border:1px solid rgba(168,147,90,.1);}
.portal-deco-1{width:600px;height:600px;top:-200px;right:-200px;}
.portal-deco-2{width:400px;height:400px;bottom:-150px;left:-100px;}
.portal-deco-3{width:200px;height:200px;top:30%;left:5%;}
.portal-inner{text-align:center;width:90%;max-width:860px;position:relative;z-index:1;padding:40px 0;}
.portal-logo-wrap{margin-bottom:32px;}
.portal-logo{width:180px;height:180px;border-radius:36px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));margin:0 auto;display:flex;align-items:center;justify-content:center;box-shadow:0 28px 70px rgba(0,0,0,.4),0 0 0 2px rgba(168,147,90,.5);}
.portal-logo svg{width:100px;height:100px;}
.portal-divider{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:10px;}
.portal-divider-line{height:1px;width:50px;background:linear-gradient(to right,transparent,var(--gold));}
.portal-divider-line.right{background:linear-gradient(to left,transparent,var(--gold));}
.portal-kicker{color:var(--gold);font-size:11px;letter-spacing:4px;text-transform:uppercase;font-weight:500;}
.portal-title{color:var(--white);font-size:clamp(28px,4vw,44px);margin-bottom:8px;letter-spacing:-.5px;}
.portal-sub{color:var(--blue-grey);font-size:14px;margin-bottom:48px;font-weight:300;}
.portal-cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:600px){.portal-cards{grid-template-columns:1fr;}}
.portal-card{background:rgba(255,255,255,.06);backdrop-filter:blur(12px);border:1px solid rgba(168,147,90,.25);border-radius:20px;padding:40px 28px;transition:all .3s ease;text-align:left;cursor:pointer;}
.portal-card:hover{background:rgba(168,147,90,.12);border-color:var(--gold);transform:translateY(-4px);box-shadow:0 20px 50px rgba(0,0,0,.3);}
.portal-card-icon{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;font-size:22px;}
.portal-card-icon.admin{background:linear-gradient(135deg,var(--gold),var(--soft-gold));}
.portal-card-icon.user{background:linear-gradient(135deg,var(--teal),var(--dk-teal));}
.portal-card h2{color:var(--white);font-size:22px;margin-bottom:8px;}
.portal-card p{color:var(--blue-grey);font-size:13px;line-height:1.6;}
.portal-footer{color:rgba(138,148,158,.4);font-size:11px;margin-top:40px;letter-spacing:.5px;}

.modal-box{background:var(--white);border-radius:24px;width:90%;max-width:480px;padding:40px;border:1px solid var(--gold);box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;position:relative;}
.modal-box.wide{max-width:640px;}
.modal-back{position:absolute;top:16px;left:16px;background:transparent;border:1px solid var(--grey);color:var(--blue-grey);border-radius:8px;padding:7px 14px;font-size:12px;}
.modal-back:hover{background:var(--cream);color:var(--navy);}
.modal-logo{display:flex;justify-content:center;margin-bottom:24px;}
.modal-box h2{text-align:center;color:var(--navy);font-size:26px;margin-bottom:6px;}
.modal-box .subtitle{text-align:center;color:var(--blue-grey);font-size:13px;margin-bottom:32px;}

/* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
#app{display:none;flex-direction:row;height:100vh;}
#app.active{display:flex;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{width:240px;background:var(--navy);flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid rgba(168,147,90,.18);}
.sidebar-logo{padding:24px 18px 20px;border-bottom:1px solid rgba(168,147,90,.14);display:flex;flex-direction:column;align-items:center;gap:14px;text-align:center;}
.sidebar-logo-icon{width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 8px 28px rgba(168,147,90,.35);}
.sidebar-logo-icon img{width:54px;height:54px;object-fit:contain;}
.sidebar-brand{}
.sidebar-brand h1{color:var(--white);font-family:'Georgia',serif;font-size:16px;font-weight:normal;letter-spacing:.3px;line-height:1.2;margin-bottom:3px;}
.sidebar-brand span{color:var(--gold);font-size:10px;letter-spacing:3px;text-transform:uppercase;font-weight:500;}
.sidebar-user{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.03);}
.sidebar-nav{flex:1;padding:16px 12px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:9px;color:var(--blue-grey);font-size:13px;font-weight:400;border:1px solid transparent;background:transparent;width:100%;text-align:left;margin-bottom:3px;}
.nav-item:hover{background:rgba(255,255,255,.06);color:var(--soft-gold);}
.nav-item.active{background:rgba(168,147,90,.16);border-color:rgba(168,147,90,.28);color:var(--soft-gold);font-weight:600;}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center;}
.sidebar-resources{margin:0 12px 12px;background:rgba(168,147,90,.07);border-radius:10px;padding:12px 14px;}
.sidebar-resources .sr-label{color:var(--gold);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;font-weight:600;}
.sr-item{display:flex;align-items:center;gap:8px;color:var(--blue-grey);font-size:12px;margin-bottom:5px;}
.sr-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0;}
.sidebar-bottom{padding:10px 12px 14px;}
.sidebar-live{display:flex;align-items:center;gap:6px;padding:7px 12px;color:var(--green);font-size:11px;font-weight:600;margin-bottom:6px;letter-spacing:.5px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;flex-shrink:0;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.btn-signout{width:100%;padding:9px;background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:9px;color:var(--blue-grey);font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px;}
.btn-signout:hover{background:rgba(255,255,255,.06);color:var(--soft-gold);border-color:rgba(168,147,90,.3);}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{padding:14px 28px;background:var(--white);border-bottom:1px solid var(--grey);display:flex;align-items:center;gap:16px;flex-shrink:0;flex-wrap:wrap;}
.resource-tabs{display:flex;gap:4px;background:var(--cream);border-radius:10px;padding:4px;}
.res-tab{padding:8px 18px;border-radius:7px;border:none;background:transparent;color:var(--blue-grey);font-size:13px;font-weight:500;display:flex;align-items:center;gap:7px;}
.res-tab.active{background:var(--navy);color:var(--white);}
.res-tab .res-dot{width:7px;height:7px;border-radius:2px;display:inline-block;}
.topbar-nav{display:flex;align-items:center;gap:8px;margin-left:auto;}
.btn-today{padding:7px 16px;background:var(--cream);border:1px solid var(--grey);border-radius:8px;font-size:12px;color:var(--navy);}
.btn-today:hover{background:var(--lt-beige);}
.btn-nav{width:32px;height:32px;background:var(--cream);border:1px solid var(--grey);border-radius:8px;font-size:16px;color:var(--navy);display:flex;align-items:center;justify-content:center;}
.btn-nav:hover{background:var(--lt-beige);}
.topbar-title{font-family:'Georgia',serif;font-size:16px;color:var(--navy);min-width:210px;text-align:center;}
.view-tabs{display:flex;gap:3px;background:var(--cream);border-radius:10px;padding:4px;}
.view-tab{padding:7px 14px;border-radius:7px;border:none;background:transparent;color:var(--blue-grey);font-size:12px;font-weight:500;text-transform:capitalize;}
.view-tab.active{background:var(--navy);color:var(--white);font-weight:600;}
.btn-book{padding:9px 20px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));border:none;border-radius:9px;color:var(--navy);font-size:13px;font-weight:700;flex-shrink:0;}
.btn-book:hover{filter:brightness(1.06);}

/* ‚îÄ‚îÄ‚îÄ CALENDAR AREA ‚îÄ‚îÄ‚îÄ */
.calendar-wrap{flex:1;overflow:auto;padding:20px 28px;}

/* ‚îÄ‚îÄ‚îÄ DAY / WEEK VIEWS ‚îÄ‚îÄ‚îÄ */
.time-grid{display:grid;border-radius:16px;overflow:hidden;border:1px solid var(--grey);background:var(--white);}
.tg-header{display:grid;background:var(--navy);border-bottom:2px solid var(--gold);font-size:11px;color:var(--soft-gold);letter-spacing:1.5px;text-transform:uppercase;}
.tg-header .th-time{padding:12px 10px;border-right:1px solid rgba(255,255,255,.08);}
.tg-header .th-day{padding:12px 8px;text-align:center;border-right:1px solid rgba(255,255,255,.08);}
.th-day-num{color:var(--white);font-family:'Georgia',serif;font-size:20px;line-height:1;}
.th-day-today .th-day-num{color:var(--gold);}
.th-today-dot{width:4px;height:4px;border-radius:50%;background:var(--gold);margin:4px auto 0;}
.tg-body{display:grid;position:relative;}
.tg-row{display:grid;border-bottom:1px solid var(--lt-beige);}
.time-cell{padding:4px 10px 0;text-align:right;color:var(--blue-grey);font-size:10px;border-right:1px solid var(--grey);font-weight:500;}
.day-cell{border-right:1px solid var(--lt-beige);position:relative;cursor:pointer;}
.day-cell:hover{background:rgba(168,147,90,.04);}
.day-cell.today-col{background:rgba(168,147,90,.03);}
.bk-chip{position:absolute;left:3px;right:3px;border-radius:6px;padding:4px 7px;overflow:hidden;z-index:5;cursor:pointer;transition:filter .15s;}
.bk-chip:hover{filter:brightness(1.1);}
.bk-chip.boardroom{background:linear-gradient(135deg,var(--teal),#006375);}
.bk-chip.car{background:linear-gradient(135deg,var(--dk-plum),var(--plum));}
.bk-title{color:var(--white);font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bk-meta{color:rgba(255,255,255,.75);font-size:10px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ‚îÄ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ‚îÄ */
.month-grid{border-radius:16px;overflow:hidden;border:1px solid var(--grey);background:var(--white);}
.month-header-row{display:grid;grid-template-columns:repeat(7,1fr);background:var(--navy);border-bottom:2px solid var(--gold);}
.month-header-row .mhc{padding:12px 8px;text-align:center;color:var(--soft-gold);font-size:11px;letter-spacing:2px;text-transform:uppercase;}
.month-body{display:grid;grid-template-columns:repeat(7,1fr);}
.month-cell{min-height:110px;border-right:1px solid var(--lt-beige);border-bottom:1px solid var(--lt-beige);padding:8px 6px;cursor:pointer;transition:background .15s;}
.month-cell:hover{background:var(--cream);}
.month-cell.other-month{background:var(--cream);opacity:.55;}
.month-cell.today{background:rgba(168,147,90,.07);}
.mc-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;margin:0 auto 5px auto;font-weight:400;}
.mc-num.today-num{background:var(--gold);color:var(--white);font-weight:700;}
.mc-chip{border-radius:4px;padding:3px 6px;margin-bottom:2px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
.mc-chip.boardroom{background:rgba(0,69,81,.15);color:var(--teal);}
.mc-chip.car{background:rgba(126,33,56,.15);color:var(--plum);}
.mc-more{font-size:10px;color:var(--blue-grey);padding-left:4px;}

/* ‚îÄ‚îÄ‚îÄ YEAR VIEW ‚îÄ‚îÄ‚îÄ */
.year-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
.mini-cal{background:var(--white);border-radius:12px;border:1px solid var(--grey);overflow:hidden;cursor:pointer;transition:all .2s;}
.mini-cal:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:var(--shadow-md);}
.mini-cal-hdr{background:var(--navy);padding:10px 12px;color:var(--white);font-family:'Georgia',serif;font-size:13px;display:flex;justify-content:space-between;align-items:center;}
.mini-cal-hdr .bk-count{background:var(--gold);color:var(--navy);font-size:9px;font-weight:700;border-radius:10px;padding:1px 6px;font-family:'Libre Franklin',sans-serif;}
.mini-cal-body{padding:6px 4px;}
.mini-days-hdr{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:3px;}
.mini-days-hdr span{text-align:center;font-size:8px;color:var(--blue-grey);padding:2px 0;}
.mini-days-body{display:grid;grid-template-columns:repeat(7,1fr);}
.mini-day{text-align:center;font-size:9px;padding:2px 0;border-radius:50%;margin:1px auto;width:18px;height:18px;display:flex;align-items:center;justify-content:center;}
.mini-day.has-bk{background:rgba(0,69,81,.15);color:var(--teal);font-weight:700;}
.mini-day.today-mini{background:var(--gold);color:var(--white);font-weight:700;}

/* ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ */
.admin-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.admin-topbar{padding:16px 28px 0;background:var(--white);border-bottom:1px solid var(--grey);flex-shrink:0;}
.admin-topbar h2{font-family:'Georgia',serif;color:var(--navy);font-size:22px;margin-bottom:14px;}
.admin-tabs{display:flex;gap:0;}
.admin-tab{padding:10px 22px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--blue-grey);font-size:13px;font-weight:400;}
.admin-tab.active{border-bottom-color:var(--gold);color:var(--navy);font-weight:600;}
.admin-tab:hover{color:var(--navy);}
.admin-body{flex:1;overflow:auto;padding:24px 28px;}

/* ‚îÄ‚îÄ‚îÄ ADMIN TABLES ‚îÄ‚îÄ‚îÄ */
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.section-hdr h3{font-family:'Georgia',serif;color:var(--navy);font-size:19px;}
.data-table{background:var(--white);border-radius:14px;overflow:hidden;border:1px solid var(--grey);box-shadow:var(--shadow-sm);}
.data-table table{width:100%;border-collapse:collapse;}
.data-table th{background:var(--navy);color:var(--gold);padding:12px 16px;text-align:left;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;}
.data-table td{padding:13px 16px;border-bottom:1px solid var(--lt-beige);font-size:13px;vertical-align:middle;}
.data-table tr:last-child td{border-bottom:none;}
.data-table tr:hover td{background:var(--cream);}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-gold{background:rgba(168,147,90,.15);color:var(--gold);}
.badge-teal{background:rgba(0,69,81,.12);color:var(--teal);}
.badge-plum{background:rgba(126,33,56,.12);color:var(--plum);}
.action-btns{display:flex;gap:6px;}
.btn-sm{padding:6px 12px;border:none;border-radius:7px;font-size:12px;font-weight:600;}
.btn-edit{background:var(--teal);color:var(--white);}
.btn-move{background:var(--dk-green);color:var(--white);}
.btn-swap{background:var(--plum);color:var(--white);}
.btn-del{background:var(--danger);color:var(--white);}

/* ‚îÄ‚îÄ‚îÄ Dept Password cards ‚îÄ‚îÄ‚îÄ */
.dept-pass-card{background:var(--white);border-radius:12px;border:1px solid var(--grey);padding:18px 20px;margin-bottom:12px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow-sm);}
.dept-pass-av{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));color:var(--navy);font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.dept-pass-info{flex:1;}
.dept-pass-name{font-weight:600;font-size:14px;color:var(--navy);}
.dept-pass-members{font-size:12px;color:var(--blue-grey);margin-top:2px;}
.dept-pass-fields{display:flex;gap:8px;align-items:center;flex:2;}
.dept-pass-fields .form-input{flex:1;margin:0;}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(13,33,54,.6);backdrop-filter:blur(5px);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.open{display:flex;}
.modal{background:var(--white);border-radius:22px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);border:1px solid var(--gold);}
.modal.modal-sm{max-width:440px;}
.modal-hdr{padding:24px 28px;border-radius:22px 22px 0 0;display:flex;justify-content:space-between;align-items:flex-start;}
.modal-hdr.navy{background:linear-gradient(135deg,var(--navy),var(--navy-light));}
.modal-hdr.teal{background:linear-gradient(135deg,var(--teal),var(--dk-teal));}
.modal-hdr.plum{background:linear-gradient(135deg,var(--plum),var(--dk-plum));}
.modal-hdr.gold{background:linear-gradient(135deg,var(--gold),var(--soft-gold));}
.modal-hdr h3{font-family:'Georgia',serif;font-size:20px;}
.modal-hdr.navy h3,.modal-hdr.teal h3,.modal-hdr.plum h3{color:var(--white);}
.modal-hdr.gold h3{color:var(--navy);}
.modal-hdr p{font-size:12px;margin-top:3px;opacity:.75;}
.modal-hdr.navy p,.modal-hdr.teal p,.modal-hdr.plum p{color:var(--soft-gold);}
.modal-hdr.gold p{color:var(--navy);}
.btn-close{width:34px;height:34px;border-radius:8px;border:none;background:rgba(255,255,255,.15);color:var(--white);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.btn-close.dark{background:var(--lt-beige);color:var(--navy);}
.modal-body{padding:24px 28px;}
.form-group{margin-bottom:18px;}
.form-label{display:block;font-size:11px;color:var(--blue-grey);margin-bottom:6px;letter-spacing:1px;text-transform:uppercase;font-weight:600;}
.form-input,.form-select{width:100%;padding:10px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--cream);transition:border-color .18s;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--gold);background:var(--white);box-shadow:0 0 0 3px rgba(168,147,90,.12);}
.form-textarea{width:100%;padding:10px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--cream);resize:vertical;min-height:70px;font-family:'Libre Franklin',sans-serif;}
.form-textarea:focus{outline:none;border-color:var(--gold);}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.toggle-group{display:flex;gap:8px;}
.toggle-btn{flex:1;padding:9px;border:2px solid var(--grey);border-radius:8px;background:transparent;font-size:13px;color:var(--blue-grey);font-weight:500;}
.toggle-btn.active{border-color:var(--gold);background:rgba(168,147,90,.1);color:var(--navy);font-weight:600;}
.recurrence-row{display:flex;gap:6px;flex-wrap:wrap;}
.rec-btn{padding:7px 14px;border:2px solid var(--grey);border-radius:8px;background:transparent;font-size:12px;color:var(--blue-grey);}
.rec-btn.active{border-color:var(--teal);background:rgba(0,69,81,.08);color:var(--teal);font-weight:600;}
.attendees-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
.att-tag{background:rgba(0,69,81,.1);color:var(--teal);border-radius:20px;padding:4px 10px;font-size:12px;display:flex;align-items:center;gap:5px;}
.att-tag button{background:none;border:none;color:var(--teal);font-size:14px;line-height:1;padding:0;}
.add-att-row{display:flex;gap:8px;margin-top:8px;}
.add-att-row .form-input{flex:1;}
.conflict-warn{background:rgba(126,33,56,.1);border:1px solid var(--plum);color:var(--plum);padding:10px 14px;border-radius:9px;font-size:13px;margin-bottom:14px;display:none;}
.conflict-warn.visible{display:block;}
.error-msg{background:rgba(192,57,43,.1);border:1px solid var(--danger);color:var(--danger);padding:10px 14px;border-radius:9px;font-size:13px;margin-bottom:14px;display:none;}
.error-msg.visible{display:block;}
.info-card{background:var(--cream);border-radius:9px;padding:12px 16px;margin-bottom:10px;}
.info-card .ic-label{font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.info-card .ic-val{color:var(--navy);font-weight:500;font-size:13px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.modal-footer{display:flex;gap:10px;margin-top:22px;}
.modal-footer .btn-prim{flex:1;padding:11px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));border:none;border-radius:9px;color:var(--navy);font-size:13px;font-weight:700;}
.modal-footer .btn-prim:hover{filter:brightness(1.06);}
.modal-footer .btn-prim.teal{background:linear-gradient(135deg,var(--teal),var(--dk-teal));color:var(--white);}
.modal-footer .btn-prim.plum{background:linear-gradient(135deg,var(--plum),var(--dk-plum));color:var(--white);}
.modal-footer .btn-sec{flex:1;padding:11px;background:var(--lt-beige);border:1px solid var(--grey);border-radius:9px;color:var(--blue-grey);font-size:13px;}

/* ‚îÄ‚îÄ‚îÄ BOOKING DETAIL ‚îÄ‚îÄ‚îÄ */
.detail-res-hdr{border-radius:14px 14px 0 0;padding:24px;position:relative;overflow:hidden;}
.detail-res-hdr::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08);}
.detail-res-hdr.boardroom{background:linear-gradient(135deg,var(--teal),#006375);}
.detail-res-hdr.car{background:linear-gradient(135deg,var(--dk-plum),var(--plum));}
.detail-kicker{color:rgba(255,255,255,.65);font-size:11px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
.detail-title{color:var(--white);font-family:'Georgia',serif;font-size:22px;line-height:1.2;}

/* ‚îÄ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ */
.notif{position:fixed;bottom:28px;right:28px;background:var(--navy);color:var(--white);padding:14px 22px;border-radius:12px;border-left:4px solid var(--gold);box-shadow:var(--shadow-md);font-size:13px;font-weight:600;z-index:9999;display:none;}

/* ‚îÄ‚îÄ‚îÄ FORM TIME DIAL ‚îÄ‚îÄ‚îÄ */
.time-dials{display:flex;align-items:center;justify-content:center;gap:24px;background:var(--cream);padding:20px;border-radius:14px;border:1px solid var(--grey);}
.dial{text-align:center;}
.dial-label{font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;}
.dial-face{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--dk-teal));color:var(--white);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;margin:0 auto 10px;box-shadow:0 4px 20px rgba(13,33,54,.3);}
.dial-controls{display:flex;gap:8px;justify-content:center;}
.dial-btn{width:32px;height:32px;border-radius:50%;border:2px solid var(--grey);background:var(--white);color:var(--navy);font-size:16px;display:flex;align-items:center;justify-content:center;}
.dial-btn:hover{border-color:var(--gold);background:var(--gold);color:var(--navy);}
.dial-sep{font-size:24px;font-weight:700;color:var(--navy);margin-top:-16px;}

/* ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:60px 20px;color:var(--blue-grey);}
.empty-state .es-icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:14px;}
.fade-in{animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.logo-ph{display:flex;align-items:center;justify-content:center;}
.search-bar{width:100%;padding:9px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--white);margin-bottom:16px;}
.search-bar:focus{outline:none;border-color:var(--gold);}

/* Dept password helper text */
.helper-text{font-size:12px;color:var(--blue-grey);line-height:1.55;margin-bottom:20px;padding:12px 16px;background:rgba(168,147,90,.08);border-radius:9px;border-left:3px solid var(--gold);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN SHEETS (mobile-style)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#admin-login-screen,#user-login-screen{
  background:rgba(10,18,30,.92);backdrop-filter:blur(12px);
  align-items:flex-end;justify-content:flex-end;padding:0;
}
.sheet{
  background:var(--white);border-radius:24px 24px 0 0;width:100%;
  padding:0 0 env(safe-area-inset-bottom,20px);
  max-height:92vh;display:flex;flex-direction:column;
  animation:sheetUp .38s cubic-bezier(.22,.68,0,1.15) forwards;
  box-shadow:0 -8px 40px rgba(0,0,0,.35);
}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;background:var(--beige);border-radius:2px;margin:14px auto 0;flex-shrink:0;}
.sheet-header{
  padding:var(--sp-md) var(--sp-md) clamp(12px,3vw,18px);
  display:flex;align-items:center;gap:var(--sp-sm);
  border-bottom:1px solid var(--lt-beige);flex-shrink:0;
}
.sheet-logo{
  width:var(--icon-sm);height:var(--icon-sm);
  border-radius:clamp(10px,3vw,14px);flex-shrink:0;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  display:flex;align-items:center;justify-content:center;
}
.sheet-logo img{width:64%;height:64%;object-fit:contain;}
.sheet-title{font-family:'Playfair Display',serif;font-size:var(--sz-lg);color:var(--navy);}
.sheet-sub{font-size:var(--sz-sm);color:var(--muted);margin-top:2px;}
.btn-sheet-back{
  margin-left:auto;width:var(--tap);height:var(--tap);border-radius:50%;
  background:var(--lt-beige);color:var(--navy);font-size:var(--sz-lg);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.sheet-body{padding:var(--sp-md);overflow-y:auto;flex:1;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOADING SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading-screen" class="screen active">
  <div class="portal-logo" style="margin-bottom:24px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));width:180px;height:180px;border-radius:36px;display:flex;align-items:center;justify-content:center;box-shadow:0 28px 70px rgba(0,0,0,.4);">
    <img src="Logo.svg" alt="Equip" style="width:130px;height:130px;object-fit:contain;">
  </div>
  <div class="spinner"></div>
  <div class="loading-text" id="loading-msg">Connecting to database‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PORTAL SELECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="portal-screen" class="screen">
  <div class="portal-deco portal-deco-1"></div>
  <div class="portal-deco portal-deco-2"></div>
  <div class="portal-deco portal-deco-3"></div>
  <div class="portal-inner fade-in">
    <div class="portal-logo-wrap">
      <div class="portal-logo">
        <img src="Logo.svg" alt="Equip" style="width:130px;height:130px;object-fit:contain;">
      </div>
    </div>
    <div class="portal-divider">
      <div class="portal-divider-line"></div>
      <span class="portal-kicker">Booking Portal</span>
      <div class="portal-divider-line right"></div>
    </div>
    <h1 class="portal-title">Welcome!</h1>
    <p class="portal-sub">Select your access level to continue</p>
    <div class="portal-cards">
      <div class="portal-card" onclick="selectPortal('admin')">
        <div class="portal-card-icon admin">üîê</div>
        <h2>Admin Portal</h2>
        <p>Manage users, departments, and all bookings. Move, swap or cancel any reservation.</p>
      </div>
      <div class="portal-card" onclick="selectPortal('user')">
        <div class="portal-card-icon user">üìÖ</div>
        <h2>User Portal</h2>
        <p>Book the board room or company car. View live schedules and manage your reservations.</p>
      </div>
    </div>
    <p class="portal-footer">¬© <span id="yr"></span> Equip Booking System ‚Äî Powered by Firebase</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="admin-login-screen" class="screen" style="background:rgba(10,18,30,.88);backdrop-filter:blur(12px);align-items:flex-end;justify-content:flex-end;" onclick="handleSheetBackdrop(event,'admin-login-screen','portal-screen')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="sheet-logo"><img src="Logo.svg" alt="Equip"></div>
      <div><div class="sheet-title">Admin Login</div><div class="sheet-sub">Enter your credentials</div></div>
      <button class="btn-sheet-back" type="button" onclick="showScreen('portal-screen','back')">√ó</button>
    </div>
    <div class="sheet-body">
      <div class="error-pill" id="login-error">Invalid username or password.</div>
      <form onsubmit="doAdminLogin();return false;" autocomplete="on">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input class="form-input" id="admin-user" name="username" placeholder="Enter username" autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="admin-pass" name="password" type="password" placeholder="Enter password" autocomplete="current-password">
        </div>
        <button class="btn-primary" type="submit" style="margin-top:4px;" id="login-btn">Login to Admin Portal</button>
      </form>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     USER LOGIN  ‚Üê replaces old user-select
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="user-login-screen" class="screen" style="background:rgba(10,18,30,.88);backdrop-filter:blur(12px);align-items:flex-end;justify-content:flex-end;" onclick="handleSheetBackdrop(event,'user-login-screen','portal-screen')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="sheet-logo"><img src="Logo.svg" alt="Equip Booking"></div>
      <div><div class="sheet-title">User Login</div><div class="sheet-sub">Enter your credentials</div></div>
      <button class="btn-sheet-back" type="button" onclick="showScreen('portal-screen','back')">√ó</button>
    </div>
    <div class="sheet-body">
      <div class="error-pill" id="user-login-error">Email not found or incorrect department password.</div>
      <form onsubmit="doUserLogin();return false;" autocomplete="on">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input class="form-input" id="user-email-input" name="email" type="email" placeholder="yourname@company.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label">Department Password</label>
          <input class="form-input" id="user-dept-pass-input" name="password" type="password" placeholder="Enter your department password" autocomplete="current-password">
        </div>
        <div style="margin-bottom:var(--sp-sm);font-size:var(--sz-xs);color:var(--muted);line-height:1.5;">
          Your department password is shared with all members of your department. Contact your admin if you don't have it.
        </div>
        <button class="btn-primary" type="submit" id="user-login-btn">Sign In</button>
      </form>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
      <div class="sidebar-brand">
        <h1>Equip Group</h1>
        <span>Booking Portal</span>
      </div>
    </div>

      </div>
    </div>

    <nav class="sidebar-nav">
      <button class="nav-item active" id="nav-calendar" onclick="switchPanel('calendar')">
        <span class="nav-icon">üìÖ</span> Calendar
      </button>
      <button class="nav-item" id="nav-admin" onclick="switchPanel('admin')" style="display:none;">
        <span class="nav-icon">‚öôÔ∏è</span> Admin Panel
      </button>
    </nav>

    <div class="sidebar-resources">
      <div class="sr-label">Resources</div>
      <div class="sr-item"><div class="sr-dot" style="background:#004551;"></div> Board Room</div>
      <div class="sr-item"><div class="sr-dot" style="background:#7e2138;"></div> Company Car</div>
    </div>

    <div class="sidebar-bottom">
            <button class="btn-signout" onclick="doLogout()">‚Üê Sign Out</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- CALENDAR PANEL -->
    <div id="panel-calendar">
      <div class="topbar">
        <div class="resource-tabs">
          <button class="res-tab active" id="tab-boardroom" onclick="switchResource('boardroom')">
            <span class="res-dot" style="background:#004551;"></span> Board Room
          </button>
          <button class="res-tab" id="tab-car" onclick="switchResource('car')">
            <span class="res-dot" style="background:#7e2138;"></span> Company Car
          </button>
        </div>
        <div class="topbar-nav">
          <button class="btn-today" onclick="goToday()">Today</button>
          <button class="btn-nav" onclick="navPrev()">‚Äπ</button>
          <button class="btn-nav" onclick="navNext()">‚Ä∫</button>
          <div class="topbar-title serif" id="cal-title">‚Äî</div>
        </div>
        <div class="view-tabs">
          <button class="view-tab" onclick="switchView('day')">Day</button>
          <button class="view-tab active" onclick="switchView('week')">Week</button>
          <button class="view-tab" onclick="switchView('month')">Month</button>
          <button class="view-tab" onclick="switchView('year')">Year</button>
        </div>
        <button class="btn-book" onclick="openBookModal(null,null)">Ôºã New Booking</button>
      </div>
      <div class="calendar-wrap" id="calendar-wrap"></div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="panel-admin" style="display:none;" class="admin-wrap">
      <div class="admin-topbar">
        <h2>Administration</h2>
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="showAdminTab('bookings')">All Bookings</button>
          <button class="admin-tab" onclick="showAdminTab('users')">Users</button>
          <button class="admin-tab" onclick="showAdminTab('admins')">Admins</button>
          <button class="admin-tab" onclick="showAdminTab('deptPasswords')">Dept Passwords</button>
        </div>
      </div>
      <div class="admin-body fade-in" id="admin-body"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- BOOKING MODAL -->
<div class="overlay" id="modal-book">
  <div class="modal fade-in">
    <div class="modal-hdr navy">
      <div><h3>New Booking</h3><p>Reserve your workspace</p></div>
      <button class="btn-close" onclick="closeModal('modal-book')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="conflict-warn" id="bk-conflict">‚ö†Ô∏è This time slot conflicts with an existing booking.</div>
      <div class="error-msg" id="bk-error"></div>
      <div class="form-group">
        <label class="form-label">Resource</label>
        <div class="toggle-group">
          <button class="toggle-btn active" id="bk-res-boardroom" onclick="setBkResource('boardroom')">üè¢ Board Room</button>
          <button class="toggle-btn" id="bk-res-car" onclick="setBkResource('car')">üöó Company Car</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Booking Title / Purpose</label>
        <input class="form-input" id="bk-purpose" placeholder="e.g. Q3 Strategy Meeting">
      </div>
      <div class="form-group">
        <label class="form-label">Book As</label>
        <div class="toggle-group">
          <button class="toggle-btn active" id="bk-as-self" onclick="setBkAs('self')">üë§ Myself</button>
          <button class="toggle-btn" id="bk-as-dept" onclick="setBkAs('dept')">üè¢ My Department</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" type="date" id="bk-date" onchange="checkConflict();updateRecPreview();">
      </div>
      <div class="form-group">
        <label class="form-label">Time</label>
        <div class="time-dials">
          <div class="dial">
            <div class="dial-label">Start</div>
            <div class="dial-face" id="dial-start">09:00</div>
            <div class="dial-controls">
              <button class="dial-btn" onclick="adjustTime('start',-30)">‚àí</button>
              <button class="dial-btn" onclick="adjustTime('start',30)">+</button>
            </div>
          </div>
          <div class="dial-sep">‚Üí</div>
          <div class="dial">
            <div class="dial-label">End</div>
            <div class="dial-face" id="dial-end">10:00</div>
            <div class="dial-controls">
              <button class="dial-btn" onclick="adjustTime('end',-30)">‚àí</button>
              <button class="dial-btn" onclick="adjustTime('end',30)">+</button>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Attendees (optional)</label>
        <div class="add-att-row">
          <select class="form-select" id="att-user-sel" style="flex:1;">
            <option value="">Add a person‚Ä¶</option>
          </select>
          <button class="btn-sm btn-edit" onclick="addAttendeeFromUser()">Ôºã</button>
          <select class="form-select" id="att-dept-sel" style="flex:1;">
            <option value="">Add a department‚Ä¶</option>
          </select>
          <button class="btn-sm btn-edit" onclick="addAttendeeFromDept()">Ôºã</button>
        </div>
        <div class="attendees-wrap" id="attendees-wrap"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Recurrence</label>
        <div class="recurrence-row">
          <button class="rec-btn active" id="rec-once" onclick="setRecurrence('once')">Once</button>
          <button class="rec-btn" id="rec-daily" onclick="setRecurrence('daily')">Daily</button>
          <button class="rec-btn" id="rec-weekdays" onclick="setRecurrence('weekdays')">Weekdays</button>
          <button class="rec-btn" id="rec-weekly" onclick="setRecurrence('weekly')">Weekly</button>
          <button class="rec-btn" id="rec-monthly" onclick="setRecurrence('monthly')">Monthly</button>
        </div>
        <div id="rec-until-wrap" style="display:none;margin-top:12px;">
          <label class="form-label">Repeat Until</label>
          <input class="form-input" type="date" id="rec-until" onchange="updateRecPreview()">
          <div style="margin-top:6px;font-size:11px;color:var(--blue-grey);" id="rec-preview"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="bk-notes" placeholder="Any additional notes‚Ä¶"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveBooking()" id="bk-submit-btn">Confirm Booking</button>
        <button class="btn-sec" onclick="closeModal('modal-book')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- BOOKING DETAIL MODAL -->
<div class="overlay" id="modal-detail">
  <div class="modal modal-sm fade-in">
    <div id="detail-hdr" class="detail-res-hdr boardroom">
      <button class="btn-close" style="position:absolute;top:16px;right:16px;" onclick="closeModal('modal-detail')">√ó</button>
      <div class="detail-kicker" id="detail-resource-label">Board Room</div>
      <div class="detail-title" id="detail-title">‚Äî</div>
    </div>
    <div class="modal-body">
      <div class="info-grid" id="detail-info-grid"></div>
      <div id="detail-attendees-wrap" style="margin-bottom:14px;display:none;">
        <div class="ic-label" style="font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Attendees</div>
        <div class="attendees-wrap" id="detail-attendees"></div>
      </div>
      <div id="detail-notes" style="display:none;background:var(--cream);border-left:3px solid var(--gold);padding:10px 14px;border-radius:0 8px 8px 0;font-size:13px;margin-bottom:14px;"></div>
      <div class="modal-footer" id="detail-actions"></div>
    </div>
  </div>
</div>

<!-- MOVE MODAL -->
<div class="overlay" id="modal-move">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr teal"><div><h3>Move Booking</h3><p>Change the date and time</p></div><button class="btn-close" onclick="closeModal('modal-move')">√ó</button></div>
    <div class="modal-body">
      <div class="info-card" id="move-booking-info"></div>
      <div class="form-group"><label class="form-label">New Date</label><input class="form-input" type="date" id="move-date"></div>
      <div class="form-group"><label class="form-label">New Start Time</label><input class="form-input" type="time" id="move-start" step="1800"></div>
      <div class="form-group"><label class="form-label">New End Time</label><input class="form-input" type="time" id="move-end" step="1800"></div>
      <div class="modal-footer">
        <button class="btn-prim teal" onclick="confirmMove()">Move Booking</button>
        <button class="btn-sec" onclick="closeModal('modal-move')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- SWAP MODAL -->
<div class="overlay" id="modal-swap">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr plum"><div><h3>Swap Bookings</h3><p>Exchange time slots between two bookings</p></div><button class="btn-close" onclick="closeModal('modal-swap')">√ó</button></div>
    <div class="modal-body">
      <div style="margin-bottom:16px;">
        <div class="ic-label" style="font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Booking A</div>
        <div class="info-card" id="swap-a-info"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Select Booking B (to swap with)</label>
        <select class="form-select" id="swap-b-sel"></select>
      </div>
      <div class="modal-footer">
        <button class="btn-prim plum" onclick="confirmSwap()">Swap Times</button>
        <button class="btn-sec" onclick="closeModal('modal-swap')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD USER MODAL -->
<div class="overlay" id="modal-add-user">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr gold"><div><h3 id="add-user-title">Add New User</h3><p>Fill in the user's details</p></div><button class="btn-close dark" onclick="closeModal('modal-add-user')">√ó</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-user-key">
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="user-name" placeholder="e.g. Alexandra Morgan"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="user-email" type="email" placeholder="name@company.com"></div>
      <div class="form-group"><label class="form-label">Department</label><input class="form-input" id="user-dept" placeholder="e.g. Finance"></div>
      <div class="form-group">
        <label class="form-label">Account Type</label>
        <select class="form-select" id="user-role">
          <option value="individual">Individual</option>
          <option value="dept">Department Account</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveUser()">Save User</button>
        <button class="btn-sec" onclick="closeModal('modal-add-user')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD ADMIN MODAL -->
<div class="overlay" id="modal-add-admin">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr navy"><div><h3 id="add-admin-title">Add Admin User</h3><p>Create administrator credentials</p></div><button class="btn-close" onclick="closeModal('modal-add-admin')">√ó</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-admin-key">
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="admin-name-input" placeholder="e.g. System Administrator"></div>
      <div class="form-group"><label class="form-label">Username</label><input class="form-input" id="admin-username-input" placeholder="e.g. admin"></div>
      <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="admin-password-input" type="password" placeholder="Set a password"></div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveAdmin()">Save Admin</button>
        <button class="btn-sec" onclick="closeModal('modal-add-admin')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAURxQJYzXb6NSzPoN6tQibZXuCyveZoKw",
  authDomain: "executive-booking-system.firebaseapp.com",
  databaseURL: "https://executive-booking-system-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "executive-booking-system",
  storageBucket: "executive-booking-system.firebasestorage.app",
  messagingSenderId: "999349397455",
  appId: "1:999349397455:web:dd4767d1a058d7756014ba"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  users:[],bookings:[],admins:[],deptPasswords:{},
  currentUser:null,isAdmin:false,
  resource:'boardroom',view:'day',
  date:new Date(),
  adminTab:'bookings',
  bkResource:'boardroom',bkAs:'self',
  bkStartMin:540,bkEndMin:600,
  bkAttendees:[],bkRecurrence:'once',
  moveTarget:null,swapTarget:null,
  weekSelectedDay:null
};

const GRID_START = 6;
const GRID_END   = 22;

document.getElementById('yr').textContent = new Date().getFullYear();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT ‚Äî anonymous auth first, then load data, restore session
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  setLoadingMsg('Connecting‚Ä¶');

  // signInAnonymously gives us a valid Firebase token so DB security rules pass.
  // App-level password validation (email + dept password) is the real identity gate.
  firebase.auth().onAuthStateChanged(async (fbUser) => {
    if (!fbUser) {
      try { await firebase.auth().signInAnonymously(); }
      catch(e) { setLoadingMsg('‚ö† Auth error: ' + e.message); }
      return; // fires again with the anon user
    }

    try {
      setLoadingMsg('Loading data‚Ä¶');
      await loadDataAndSeed();

      // Restore saved session from localStorage ‚Äî no re-login needed
      const saved = loadSavedSession();
      if (saved) {
        S.currentUser = saved.user;
        S.isAdmin     = saved.isAdmin;
        initApp();
      } else {
        showScreen('portal-screen');
      }
    } catch(e) {
      setLoadingMsg('‚ö† ' + e.message);
    }
  });
});

function setLoadingMsg(m) { document.getElementById('loading-msg').textContent = m; }

// ‚îÄ‚îÄ‚îÄ Load all collections + seed on first run ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDataAndSeed() {
  return new Promise((resolve, reject) => {
    let ready = {users:false,bookings:false,admins:false,deptPasswords:false,meta:false};
    let seeded = false;

    const check = async () => {
      if (!Object.values(ready).every(Boolean)) return;
      if (!seeded) { seeded = true; await ensureDefaultData(); }
      resolve();
    };

    db.ref('users').on('value', snap => {
      S.users = Object.entries(snap.val()||{}).map(([k,v])=>({...v,_key:k}));
      if (!ready.users) { ready.users = true; check(); }
      refreshIfNeeded('users');
    });
    db.ref('bookings').on('value', snap => {
      S.bookings = Object.entries(snap.val()||{}).map(([k,v])=>({...v,_key:k}));
      if (!ready.bookings) { ready.bookings = true; check(); }
      refreshIfNeeded('bookings');
    });
    db.ref('admins').on('value', snap => {
      S.admins = Object.entries(snap.val()||{}).map(([k,v])=>({...v,_key:k}));
      if (!ready.admins) { ready.admins = true; check(); }
      refreshIfNeeded('admins');
    });
    db.ref('deptPasswords').on('value', snap => {
      S.deptPasswords = snap.val() || {};
      if (!ready.deptPasswords) { ready.deptPasswords = true; check(); }
    });
    db.ref('meta').once('value', () => { ready.meta = true; check(); });

    setTimeout(() => reject(new Error('Database timed out ‚Äî check your connection')), 15000);
  });
}

function refreshIfNeeded(col) {
  if (!S.currentUser) return;
  if (col === 'bookings') renderCalendar();
  if (S.isAdmin) renderAdminTab();
}

// ‚îÄ‚îÄ‚îÄ Seed default data on very first run only ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses meta/initialized flag ‚Äî safe to call on every boot.
async function ensureDefaultData() {
  const snap = await db.ref('meta/initialized').once('value');
  if (snap.val() === true) return;

  setLoadingMsg('First run ‚Äî setting up workspace‚Ä¶');

  if (!(await db.ref('admins').once('value')).exists()) {
    await db.ref('admins').set({admin1:{username:'admin',password:'admin123',name:'System Administrator'}});
  }
  if (!(await db.ref('users').once('value')).exists()) {
    await db.ref('users').set({
      user1:{id:'u1',name:'Alexandra Morgan',department:'Executive',role:'individual',email:'a.morgan@corp.com'},
      user2:{id:'u2',name:'James Whitfield',department:'Finance',role:'individual',email:'j.whitfield@corp.com'},
      user3:{id:'u3',name:'Sarah Chen',department:'Marketing',role:'individual',email:'s.chen@corp.com'},
      user4:{id:'u4',name:'David Okafor',department:'Operations',role:'individual',email:'d.okafor@corp.com'},
      user5:{id:'u5',name:'Priya Nair',department:'Human Resources',role:'individual',email:'p.nair@corp.com'},
      user6:{id:'u6',name:'Finance Dept',department:'Finance',role:'dept',email:'finance@corp.com'},
      user7:{id:'u7',name:'Marketing Dept',department:'Marketing',role:'dept',email:'marketing@corp.com'},
    });
  }
  if (!(await db.ref('bookings').once('value')).exists()) await db.ref('bookings').set({});
  if (!(await db.ref('deptPasswords').once('value')).exists()) {
    await db.ref('deptPasswords').set({
      'Executive':'exec2024','Finance':'finance2024','Marketing':'marketing2024',
      'Operations':'ops2024','Human Resources':'hr2024',
    });
  }
  await db.ref('meta/initialized').set(true);
}

// ‚îÄ‚îÄ‚îÄ Session persistence via localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Keeps users logged in across page reloads / PWA restarts.
const SESSION_KEY = 'equipMobile_session';

function saveSession(user, isAdmin) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({key: user._key, type: isAdmin ? 'admin' : 'user'}));
  } catch(e) {}
}
function clearSession() {
  try { localStorage.removeItem(SESSION_KEY); } catch(e) {}
}
function loadSavedSession() {
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    const {key, type} = JSON.parse(raw);
    if (type === 'admin') {
      const admin = S.admins.find(a => a._key === key);
      if (!admin) { clearSession(); return null; }
      return {user: {...admin, type:'admin'}, isAdmin: true};
    } else {
      const user = S.users.find(u => u._key === key);
      if (!user) { clearSession(); return null; }
      return {user: {...user, type:'user'}, isAdmin: false};
    }
  } catch(e) { clearSession(); return null; }
}

// ‚îÄ‚îÄ‚îÄ Credential Management API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Explicitly tells the browser to offer "Save password?" after a
// successful SPA login (Chrome/Edge). Silently skipped elsewhere.
function storeCredential(id, password, name) {
  if (!window.PasswordCredential) return;
  try {
    const cred = new PasswordCredential({id, password, name});
    navigator.credentials.store(cred).catch(() => {});
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id, direction) {
  const current = document.querySelector('.screen.active');
  const next = document.getElementById(id);
  if (!next || next === current) return;
  if (current) {
    current.style.pointerEvents = 'none';
    current.classList.add('exit');
    setTimeout(() => { current.classList.remove('active','exit'); current.style.pointerEvents = ''; }, 300);
  }
  const cls = direction === 'back' ? 'enter-back' : 'enter';
  next.classList.add('active', cls);
  setTimeout(() => next.classList.remove(cls), 420);
}
function handleSheetBackdrop(e, screenId, backTo) {
  if (e.target === document.getElementById(screenId)) showScreen(backTo, 'back');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PORTAL SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectPortal(type) {
  if (type === 'admin') {
    document.getElementById('admin-user').value = '';
    document.getElementById('admin-pass').value = '';
    document.getElementById('login-error').classList.remove('visible');
    showScreen('admin-login-screen');
  } else {
    document.getElementById('user-email-input').value = '';
    document.getElementById('user-dept-pass-input').value = '';
    document.getElementById('user-login-error').classList.remove('visible');
    showScreen('user-login-screen');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doAdminLogin() {
  const u = document.getElementById('admin-user').value.trim();
  const p = document.getElementById('admin-pass').value.trim();
  const admin = S.admins.find(a => a.username === u && a.password === p);
  if (!admin) {
    document.getElementById('login-error').classList.add('visible');
    shakeSheet('admin-login-screen');
    return;
  }
  storeCredential(u, p, admin.name || 'Admin');
  S.currentUser = {...admin, type:'admin'};
  S.isAdmin = true;
  saveSession(S.currentUser, true);
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER LOGIN (email + department shared password)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doUserLogin() {
  const email = document.getElementById('user-email-input').value.trim().toLowerCase();
  const pass  = document.getElementById('user-dept-pass-input').value.trim();
  const errEl = document.getElementById('user-login-error');
  errEl.classList.remove('visible');

  if (!email || !pass) {
    errEl.textContent = 'Please enter your email and department password.';
    errEl.classList.add('visible');
    return;
  }
  const user = S.users.find(u => (u.email||'').toLowerCase() === email);
  if (!user) {
    errEl.textContent = 'No account found with that email address.';
    errEl.classList.add('visible');
    shakeSheet('user-login-screen');
    return;
  }
  const dept = user.department || '';
  const correctPass = S.deptPasswords[dept];
  if (!correctPass) {
    errEl.textContent = 'Your department does not have a password set yet. Contact your admin.';
    errEl.classList.add('visible');
    return;
  }
  if (pass !== correctPass) {
    errEl.textContent = 'Incorrect department password. Try again.';
    errEl.classList.add('visible');
    shakeSheet('user-login-screen');
    return;
  }
  storeCredential(email, pass, user.name);
  S.currentUser = {...user, type:'user'};
  S.isAdmin = false;
  saveSession(S.currentUser, false);
  initApp();
}

function shakeSheet(screenId) {
  const sh = document.querySelector('#' + screenId + ' .sheet');
  if (!sh) return;
  sh.style.transform = 'translateX(-10px)';
  setTimeout(() => sh.style.transform = 'translateX(10px)', 80);
  setTimeout(() => sh.style.transform = '', 160);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP INIT / LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  const u = S.currentUser;
  document.getElementById('tb-user-btn').textContent = initials(u.name);
  if (S.isAdmin) document.getElementById('nav-admin').style.display = 'flex';
  S.weekSelectedDay = dateStr(S.date);
  populateAttendeeDropdowns();
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = ''; });
  document.getElementById('app').classList.add('active');
  if (S.isAdmin) switchPanel('admin'); else switchPanel('calendar');
  notify('Welcome, ' + u.name.split(' ')[0] + ' \u2713');
}

function doLogout() {
  clearSession();
  S.currentUser = null;
  S.isAdmin = false;
  document.getElementById('app').classList.remove('active');
  document.getElementById('nav-admin').style.display = 'none';
  closeModal('modal-profile');
  showScreen('portal-screen', 'back');
}

function openProfileSheet() {
  if (!S.currentUser) return;
  const u = S.currentUser;
  document.getElementById('profile-info-card').innerHTML = `
    <div class="profile-av">${initials(u.name)}</div>
    <div><div class="profile-name">${u.name}</div><div class="profile-role">${S.isAdmin ? 'Administrator' : (u.department||'User')}</div></div>`;
  openModal('modal-profile');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PANEL / RESOURCE / VIEW / NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPanel(panel) {
  const calEl = document.getElementById('panel-calendar');
  const adminEl = document.getElementById('panel-admin');
  calEl.style.display = panel === 'calendar' ? 'flex' : 'none';
  calEl.style.flexDirection = 'column';
  adminEl.style.display = panel === 'admin' ? 'flex' : 'none';
  adminEl.style.flexDirection = panel === 'admin' ? 'column' : 'none';
  document.getElementById('nav-calendar').classList.toggle('active', panel === 'calendar');
  const na = document.getElementById('nav-admin');
  if (na) na.classList.toggle('active', panel === 'admin');
  if (panel === 'calendar') renderCalendar(); else renderAdminTab();
}
function switchResource(r) {
  S.resource = r;
  document.getElementById('res-boardroom').className = `res-pill${r==='boardroom'?' active boardroom':''}`;
  document.getElementById('res-car').className = `res-pill${r==='car'?' active car':''}`;
  renderCalendar();
}
function switchView(v) {
  S.view = v;
  document.querySelectorAll('.view-pill').forEach(b => b.classList.toggle('active', b.dataset.v === v));
  renderCalendar();
}
function navPrev() {
  const d = new Date(S.date);
  if (S.view==='day') d.setDate(d.getDate()-1);
  else if (S.view==='week') { d.setDate(d.getDate()-7); S.weekSelectedDay = dateStr(d); }
  else if (S.view==='month') d.setMonth(d.getMonth()-1);
  else if (S.view==='year') d.setFullYear(d.getFullYear()-1);
  S.date = d; renderCalendar();
}
function navNext() {
  const d = new Date(S.date);
  if (S.view==='day') d.setDate(d.getDate()+1);
  else if (S.view==='week') { d.setDate(d.getDate()+7); S.weekSelectedDay = dateStr(d); }
  else if (S.view==='month') d.setMonth(d.getMonth()+1);
  else if (S.view==='year') d.setFullYear(d.getFullYear()+1);
  S.date = d; renderCalendar();
}
function goToday() { S.date = new Date(); S.weekSelectedDay = dateStr(S.date); renderCalendar(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toMin(t){const[h,m]=t.split(':').map(Number);return h*60+m;}
function fromMin(m){return`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;}
function dateStr(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function isSameDay(a,b){return dateStr(a)===dateStr(b);}
function startOfWeek(d){const x=new Date(d);x.setDate(x.getDate()-x.getDay());x.setHours(0,0,0,0);return x;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CALENDAR RENDER ROUTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar(){
  const wrap=document.getElementById('cal-body');if(!wrap)return;
  const bks=S.bookings.filter(b=>b.resource===S.resource);
  if(S.view==='day'){
    document.getElementById('cal-title').textContent=S.date.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    renderDayTimeGrid(wrap,bks,dateStr(S.date));
  }else if(S.view==='week'){
    const ws=startOfWeek(S.date),we=addDays(ws,6);
    document.getElementById('cal-title').textContent=ws.toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' \u2013 '+we.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    renderWeekView(wrap,bks);
  }else if(S.view==='month'){
    document.getElementById('cal-title').textContent=`${MONTHS[S.date.getMonth()]} ${S.date.getFullYear()}`;
    renderMonthView(wrap,bks);
  }else if(S.view==='year'){
    document.getElementById('cal-title').textContent=S.date.getFullYear();
    renderYearView(wrap,bks);
  }
}

function renderDayTimeGrid(wrap,bks,ds){
  const dayBks=bks.filter(b=>b.date===ds);
  const todayStr=dateStr(new Date()),isToday=ds===todayStr;
  const dateObj=new Date(ds+'T12:00:00');
  const hourPx=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-px'))||72;
  const totalHours=GRID_END-GRID_START;
  let nowLineHtml='';
  if(isToday){
    const now=new Date(),nowMin=now.getHours()*60+now.getMinutes();
    if(nowMin>=GRID_START*60&&nowMin<=GRID_END*60){
      const topPct=((nowMin-GRID_START*60)/(totalHours*60))*100;
      nowLineHtml=`<div class="tg-now-line" style="top:${topPct}%;"><div class="tg-now-dot"></div><div class="tg-now-rule"></div></div>`;
    }
  }
  const bkBlocks=dayBks.map(b=>{
    const sMin=toMin(b.startTime),eMin=toMin(b.endTime);
    const topPct=((sMin-GRID_START*60)/(totalHours*60))*100;
    const heightPct=((eMin-sMin)/(totalHours*60))*100;
    const showMeta=(eMin-sMin)>=45;
    return`<div class="tg-bk ${b.resource}" style="top:${topPct}%;height:${heightPct}%;" onclick="event.stopPropagation();openDetail('${b._key}')">
      <div class="tg-bk-title">${b.purpose}</div>
      ${showMeta?`<div class="tg-bk-meta">${b.startTime}\u2013${b.endTime} \u00b7 ${b.user||''}</div>`:''}
    </div>`;
  }).join('');
  let rowsHtml='';
  for(let h=GRID_START;h<GRID_END;h++){
    const label=h===12?'12pm':h<12?`${h}am`:`${h-12}pm`;
    const hStr=String(h).padStart(2,'0');
    rowsHtml+=`<div class="tg-row half-mark"><div class="tg-time">${label}</div><div class="tg-cell" onclick="openBookModal('${ds}','${hStr}:00')"></div></div>`;
  }
  wrap.innerHTML=`<div class="day-grid-wrap fade-in">
    <div class="day-grid-date-hdr">
      <span class="day-grid-date-text">${dateObj.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'})}</span>
      ${isToday?'<span class="day-grid-today-badge">Today</span>':''}
    </div>
    <div class="day-time-grid" style="position:relative;">${rowsHtml}${bkBlocks}${nowLineHtml}</div>
  </div>`;
  requestAnimationFrame(()=>{
    const gridEl=wrap.querySelector('.day-time-grid');if(!gridEl)return;
    const now=new Date();
    const targetMin=isToday?Math.max(now.getHours()*60+now.getMinutes()-60,GRID_START*60):8*60;
    wrap.scrollTop=Math.max(0,((targetMin-GRID_START*60)/(totalHours*60))*gridEl.offsetHeight-60);
  });
}

function renderWeekView(wrap,bks){
  const ws=startOfWeek(S.date),todayStr=dateStr(new Date());
  if(!S.weekSelectedDay)S.weekSelectedDay=dateStr(S.date);
  const wdays=Array.from({length:7},(_,i)=>addDays(ws,i));
  const wdStrs=wdays.map(d=>dateStr(d));
  if(!wdStrs.includes(S.weekSelectedDay))S.weekSelectedDay=wdStrs.find(d=>d===todayStr)||wdStrs[0];
  const strip=wdays.map(d=>{
    const ds=dateStr(d),isToday=ds===todayStr,isSelected=ds===S.weekSelectedDay;
    const bksDay=bks.filter(b=>b.date===ds);
    const dots=bksDay.slice(0,3).map(b=>`<div class="mc-dot ${b.resource}"></div>`).join('');
    return`<button class="week-day-btn${isSelected?' active':''}${bksDay.length&&!isSelected?' has-bk':''}${isToday&&!isSelected?' today-day':''}" onclick="S.weekSelectedDay='${ds}';renderCalendar();">
      <div class="week-day-label">${DAYS[d.getDay()]}</div>
      <div class="week-day-num">${d.getDate()}</div>
      <div class="week-dot-row">${dots}</div>
    </button>`;
  }).join('');
  wrap.innerHTML=`<div class="week-strip fade-in">${strip}</div><div style="flex:1;overflow-y:auto;" id="week-day-body"></div>`;
  const body=wrap.querySelector('#week-day-body');
  if(body)renderDayTimeGrid(body,bks,S.weekSelectedDay);
}

function renderMonthView(wrap,bks){
  const d=S.date,todayStr=dateStr(new Date());
  const first=new Date(d.getFullYear(),d.getMonth(),1);
  const pad=first.getDay(),dim=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
  const cells=[];
  for(let i=0;i<pad;i++)cells.push({day:null,ds:null});
  for(let i=1;i<=dim;i++){const cd=new Date(d.getFullYear(),d.getMonth(),i);cells.push({day:i,ds:dateStr(cd)});}
  while(cells.length%7!==0)cells.push({day:null,ds:null});
  const bodyHtml=cells.map(c=>{
    if(!c.day)return`<div class="month-cell other-month"></div>`;
    const isT=c.ds===todayStr,dayBks=bks.filter(b=>b.date===c.ds);
    const dots=dayBks.slice(0,3).map(b=>`<div class="mc-dot ${b.resource}"></div>`).join('');
    const more=dayBks.length>3?`<div class="mc-more">+${dayBks.length-3}</div>`:'';
    return`<div class="month-cell${isT?' today':''}" onclick="S.date=new Date('${c.ds}T12:00:00');switchView('day');">
      <div class="mc-num${isT?' today-num':''}">${c.day}</div>
      <div class="mc-dot-row">${dots}</div>${more}
    </div>`;
  }).join('');
  wrap.innerHTML=`<div class="month-view-wrap fade-in"><div class="month-grid">
    <div class="month-hdr-row">${'SMTWTFS'.split('').map(x=>`<div class="mhc">${x}</div>`).join('')}</div>
    <div class="month-body-grid">${bodyHtml}</div>
  </div></div>`;
}

function renderYearView(wrap,bks){
  const yr=S.date.getFullYear(),today=new Date();
  const cards=MONTHS.map((mn,mi)=>{
    const first=new Date(yr,mi,1),dim=new Date(yr,mi+1,0).getDate(),pad=first.getDay();
    const bksM=bks.filter(b=>{const bd=new Date(b.date+'T12:00:00');return bd.getFullYear()===yr&&bd.getMonth()===mi;});
    const cells=[];
    for(let i=0;i<pad;i++)cells.push('');
    for(let d=1;d<=dim;d++)cells.push(d);
    const daysHtml=cells.map(d=>{
      if(!d)return`<div class="mini-day other"></div>`;
      const ds=`${yr}-${String(mi+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const hasB=bksM.some(b=>b.date===ds),isT=isSameDay(new Date(ds+'T12:00:00'),today);
      return`<div class="mini-day${isT?' today-mini':hasB?' has-bk':''}">${d}</div>`;
    }).join('');
    return`<div class="mini-cal" onclick="S.date=new Date(${yr},${mi},1);switchView('month');">
      <div class="mini-cal-hdr"><span>${mn}</span>${bksM.length?`<span class="mini-bk-badge">${bksM.length}</span>`:''}</div>
      <div class="mini-cal-body">
        <div class="mini-days-hdr">${'SMTWTFS'.split('').map(x=>`<span>${x}</span>`).join('')}</div>
        <div class="mini-days-body">${daysHtml}</div>
      </div>
    </div>`;
  }).join('');
  wrap.innerHTML=`<div class="year-view-wrap fade-in"><div class="year-grid">${cards}</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOKING MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBookModal(prefillDate,prefillTime){
  S.bkResource=S.resource;S.bkAs='self';S.bkAttendees=[];S.bkRecurrence='once';
  S.bkStartMin=prefillTime?toMin(prefillTime):540;S.bkEndMin=S.bkStartMin+60;
  setBkResource(S.bkResource);setBkAs('self');setRecurrence('once');
  document.getElementById('bk-purpose').value='';
  document.getElementById('bk-notes').value='';
  document.getElementById('bk-date').value=prefillDate||dateStr(S.date);
  document.getElementById('bk-conflict').classList.remove('visible');
  const errEl=document.getElementById('bk-error');errEl.classList.remove('visible');errEl.style.display='none';
  document.getElementById('rec-until').value='';
  document.getElementById('rec-until-wrap').style.display='none';
  renderAttendeeTags();updateDials();openModal('modal-book');
}
function setBkResource(r){S.bkResource=r;document.getElementById('bk-res-boardroom').classList.toggle('active',r==='boardroom');document.getElementById('bk-res-car').classList.toggle('active',r==='car');checkConflict();}
function setBkAs(a){S.bkAs=a;document.getElementById('bk-as-self').classList.toggle('active',a==='self');document.getElementById('bk-as-dept').classList.toggle('active',a==='dept');}
function adjustTime(w,d){
  if(w==='start'){S.bkStartMin=Math.max(GRID_START*60,Math.min(GRID_END*60-30,S.bkStartMin+d));if(S.bkEndMin<=S.bkStartMin)S.bkEndMin=S.bkStartMin+30;}
  else{S.bkEndMin=Math.max(S.bkStartMin+30,Math.min(GRID_END*60,S.bkEndMin+d));}
  updateDials();checkConflict();
}
function updateDials(){document.getElementById('dial-start').textContent=fromMin(S.bkStartMin);document.getElementById('dial-end').textContent=fromMin(S.bkEndMin);}
function setRecurrence(r){
  S.bkRecurrence=r;
  ['once','daily','weekdays','weekly','monthly'].forEach(v=>document.getElementById('rec-'+v).classList.toggle('active',v===r));
  const wrap=document.getElementById('rec-until-wrap');
  wrap.style.display=r==='once'?'none':'block';
  if(r!=='once'){const u=document.getElementById('rec-until');if(!u.value){const def=new Date();def.setMonth(def.getMonth()+3);u.value=dateStr(def);}updateRecPreview();}
}
function populateAttendeeDropdowns(){
  const uSel=document.getElementById('att-user-sel'),dSel=document.getElementById('att-dept-sel');
  uSel.innerHTML='<option value="">Add person\u2026</option>'+S.users.map(u=>`<option value="${u.name}">${u.name} (${u.department})</option>`).join('');
  const depts=[...new Set(S.users.map(u=>u.department))].sort();
  dSel.innerHTML='<option value="">Add department\u2026</option>'+depts.map(d=>`<option value="${d}">${d}</option>`).join('');
}
function addAttendeeFromUser(){const v=document.getElementById('att-user-sel').value;if(v&&!S.bkAttendees.includes(v)){S.bkAttendees.push(v);renderAttendeeTags();}document.getElementById('att-user-sel').value='';}
function addAttendeeFromDept(){const dept=document.getElementById('att-dept-sel').value;if(!dept)return;S.users.filter(u=>u.department===dept).forEach(u=>{if(!S.bkAttendees.includes(u.name))S.bkAttendees.push(u.name);});renderAttendeeTags();document.getElementById('att-dept-sel').value='';}
function removeAttendee(name){S.bkAttendees=S.bkAttendees.filter(a=>a!==name);renderAttendeeTags();}
function renderAttendeeTags(){document.getElementById('attendees-wrap').innerHTML=S.bkAttendees.map(a=>`<div class="att-tag">${a}<button onclick="removeAttendee('${a.replace(/'/g,"\\'")}')">x</button></div>`).join('');}
function checkConflict(){
  const date=document.getElementById('bk-date').value;if(!date)return;
  const st=fromMin(S.bkStartMin),et=fromMin(S.bkEndMin);
  const c=S.bookings.some(b=>b.resource===S.bkResource&&b.date===date&&toMin(b.startTime)<toMin(et)&&toMin(b.endTime)>toMin(st));
  document.getElementById('bk-conflict').classList.toggle('visible',c);
}
function buildRecurrenceDates(baseDate,type,untilDate){
  if(type==='once'||!untilDate||untilDate<baseDate)return[baseDate];
  const dates=[];let cur=new Date(baseDate+'T12:00:00');
  const until=new Date(untilDate+'T12:00:00');const MAX=365;
  while(cur<=until&&dates.length<MAX){
    if(type!=='weekdays'||(cur.getDay()!==0&&cur.getDay()!==6))dates.push(dateStr(cur));
    if(type==='daily'||type==='weekdays')cur=addDays(cur,1);
    else if(type==='weekly')cur=addDays(cur,7);
    else if(type==='monthly'){const x=new Date(cur);x.setMonth(x.getMonth()+1);cur=x;}
    else break;
  }
  return dates.length>0?dates:[baseDate];
}
function updateRecPreview(){
  const dv=document.getElementById('bk-date').value,u=document.getElementById('rec-until').value,p=document.getElementById('rec-preview');
  if(!p)return;if(!dv||!u||S.bkRecurrence==='once'){p.textContent='';return;}
  const dates=buildRecurrenceDates(dv,S.bkRecurrence,u);
  p.textContent=`${dates.length} booking${dates.length!==1?'s':''} will be created`;
}
async function saveBooking(){
  const purpose=document.getElementById('bk-purpose').value.trim();
  const date=document.getElementById('bk-date').value;
  if(!purpose){showBkError('Please enter a title.');return;}
  if(!date){showBkError('Please select a date.');return;}
  const startT=fromMin(S.bkStartMin),endT=fromMin(S.bkEndMin);
  const conflict=S.bookings.some(b=>b.resource===S.bkResource&&b.date===date&&toMin(b.startTime)<toMin(endT)&&toMin(b.endTime)>toMin(startT));
  if(conflict){showBkError('Time slot conflicts with an existing booking.');return;}
  const btn=document.getElementById('bk-submit-btn');btn.textContent='Saving\u2026';btn.disabled=true;
  const untilDate=document.getElementById('rec-until').value;
  const dates=buildRecurrenceDates(date,S.bkRecurrence,untilDate);
  const groupId=dates.length>1?uid():null;
  try{
    for(const d of dates){
      await db.ref('bookings').push({resource:S.bkResource,date:d,startTime:startT,endTime:endT,user:S.currentUser.name,userId:S.currentUser.id||S.currentUser._key||'',department:S.currentUser.department||'',bookedAs:S.bkAs,purpose,attendees:S.bkAttendees.join(', '),notes:document.getElementById('bk-notes').value.trim(),groupId,createdAt:new Date().toISOString()});
    }
    closeModal('modal-book');
    notify(dates.length>1?`${dates.length} recurring bookings saved \u2713`:'Booking confirmed \u2713');
  }catch(e){showBkError('Failed: '+e.message);}
  finally{btn.textContent='Confirm Booking';btn.disabled=false;}
}
function showBkError(msg){const el=document.getElementById('bk-error');el.textContent=msg;el.style.display='block';el.classList.add('visible');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOKING DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(key){
  const b=S.bookings.find(x=>x._key===key);if(!b)return;
  const canManage=S.isAdmin||b.userId===(S.currentUser.id||S.currentUser._key)||b.user===S.currentUser.name;
  document.getElementById('detail-hdr').className=`detail-res-banner ${b.resource}`;
  document.getElementById('detail-resource-label').textContent=b.resource==='boardroom'?'Board Room':'Company Car';
  document.getElementById('detail-title').textContent=b.purpose;
  const dateObj=new Date(b.date+'T12:00:00');
  document.getElementById('detail-info-grid').innerHTML=`
    <div class="info-card"><div class="ic-label">Date</div><div class="ic-val">${dateObj.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}</div></div>
    <div class="info-card"><div class="ic-label">Time</div><div class="ic-val">${b.startTime} \u2013 ${b.endTime}</div></div>
    <div class="info-card"><div class="ic-label">Booked By</div><div class="ic-val">${b.user||'\u2014'}</div></div>
    <div class="info-card"><div class="ic-label">Booked As</div><div class="ic-val">${b.bookedAs==='dept'?'Department':'Individual'}</div></div>`;
  const attWrap=document.getElementById('detail-attendees-wrap');
  if(b.attendees){attWrap.style.display='block';document.getElementById('detail-attendees').innerHTML=b.attendees.split(',').filter(Boolean).map(a=>`<div class="att-tag">${a.trim()}</div>`).join('');}
  else attWrap.style.display='none';
  const notesEl=document.getElementById('detail-notes');
  if(b.notes){notesEl.style.display='block';notesEl.textContent=b.notes;}else notesEl.style.display='none';
  const actEl=document.getElementById('detail-actions');
  if(canManage){
    const hasSeries=b.groupId&&S.bookings.filter(x=>x.groupId===b.groupId).length>1;
    const sc=hasSeries?S.bookings.filter(x=>x.groupId===b.groupId).length:0;
    actEl.innerHTML=`<div style="display:flex;flex-direction:column;gap:10px;">
      ${S.isAdmin?`<div style="display:flex;gap:10px;"><button class="btn-primary" style="background:linear-gradient(135deg,var(--teal),#004d58);color:white;" onclick="openMoveModal('${key}');closeModal('modal-detail');">Move</button><button class="btn-primary" style="background:linear-gradient(135deg,var(--plum),#6b1a33);color:white;" onclick="openSwapModal('${key}');closeModal('modal-detail');">Swap</button></div>`:''}
      <button class="btn-secondary" style="color:var(--danger);border:1px solid rgba(192,57,43,.2);" onclick="deleteBooking('${key}',false)">Remove This Booking</button>
      ${hasSeries?`<button class="btn-secondary" style="color:var(--danger);background:rgba(192,57,43,.08);border:1px solid rgba(192,57,43,.3);font-weight:700;" onclick="deleteBooking('${key}',true)">Remove All ${sc} in Series</button>`:''}
    </div>`;
  }else actEl.innerHTML='';
  openModal('modal-detail');
}
async function deleteBooking(key,deleteSeries){
  const b=S.bookings.find(x=>x._key===key);if(!b)return;
  if(deleteSeries&&b.groupId){
    const skeys=S.bookings.filter(x=>x.groupId===b.groupId).map(x=>x._key);
    if(!confirm(`Remove all ${skeys.length} bookings in series?`))return;
    try{await Promise.all(skeys.map(k=>db.ref('bookings/'+k).remove()));closeModal('modal-detail');notify(`${skeys.length} bookings removed \u2713`);}
    catch(e){alert('Failed: '+e.message);}
  }else{
    if(!confirm('Remove this booking?'))return;
    try{await db.ref('bookings/'+key).remove();closeModal('modal-detail');notify('Booking removed \u2713');}
    catch(e){alert('Failed: '+e.message);}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOVE / SWAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMoveModal(key){
  const b=S.bookings.find(x=>x._key===key);if(!b)return;
  S.moveTarget=key;
  document.getElementById('move-booking-info').innerHTML=`<div class="ic-label">Moving</div><div class="ic-val">${b.purpose} \u00b7 ${b.date} ${b.startTime}\u2013${b.endTime}</div>`;
  document.getElementById('move-date').value=b.date;
  document.getElementById('move-start').value=b.startTime;
  document.getElementById('move-end').value=b.endTime;
  openModal('modal-move');
}
async function confirmMove(){
  const nd=document.getElementById('move-date').value,ns=document.getElementById('move-start').value,ne=document.getElementById('move-end').value;
  if(!nd||!ns||!ne)return;
  if(toMin(ne)<=toMin(ns)){alert('End time must be after start.');return;}
  try{await db.ref('bookings/'+S.moveTarget).update({date:nd,startTime:ns,endTime:ne});closeModal('modal-move');notify('Booking moved \u2713');}
  catch(e){alert('Failed: '+e.message);}
}
function openSwapModal(key){
  const b=S.bookings.find(x=>x._key===key);if(!b)return;
  S.swapTarget=key;
  document.getElementById('swap-a-info').innerHTML=`<div class="ic-val">${b.purpose} \u00b7 ${b.date} ${b.startTime}\u2013${b.endTime}</div>`;
  const others=S.bookings.filter(x=>x._key!==key&&x.resource===b.resource);
  document.getElementById('swap-b-sel').innerHTML='<option value="">Select\u2026</option>'+others.map(x=>`<option value="${x._key}">${x.purpose} \u2014 ${x.date} ${x.startTime}\u2013${x.endTime}</option>`).join('');
  openModal('modal-swap');
}
async function confirmSwap(){
  const bKey=document.getElementById('swap-b-sel').value;if(!bKey){alert('Select a booking.');return;}
  const a=S.bookings.find(x=>x._key===S.swapTarget),b=S.bookings.find(x=>x._key===bKey);if(!a||!b)return;
  try{
    await db.ref('bookings/'+S.swapTarget).update({date:b.date,startTime:b.startTime,endTime:b.endTime});
    await db.ref('bookings/'+bKey).update({date:a.date,startTime:a.startTime,endTime:a.endTime});
    closeModal('modal-swap');notify('Bookings swapped \u2713');
  }catch(e){alert('Failed: '+e.message);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAdminTab(tab){
  S.adminTab=tab;
  document.querySelectorAll('.admin-tab-btn').forEach((t,i)=>t.classList.toggle('active',['bookings','users','admins','deptPasswords'][i]===tab));
  renderAdminTab();
}
function renderAdminTab(){
  const el=document.getElementById('admin-body');if(!el)return;
  if(S.adminTab==='bookings')el.innerHTML=renderAdminBookings();
  else if(S.adminTab==='users')el.innerHTML=renderAdminUsers();
  else if(S.adminTab==='admins')el.innerHTML=renderAdminAdmins();
  else el.innerHTML=renderDeptPasswords();
}
function renderAdminBookings(){
  const sorted=[...S.bookings].sort((a,b)=>a.date>b.date?-1:1);
  const cards=sorted.map(b=>{
    const hasSeries=b.groupId&&S.bookings.filter(x=>x.groupId===b.groupId).length>1;
    return`<div class="admin-bk-card ${b.resource}">
      <div class="admin-bk-card-top">
        <div><div class="admin-bk-card-title">${b.purpose}${hasSeries?`<span class="series-tag">Series</span>`:''}</div><div class="admin-bk-card-meta">${b.date} \u00b7 ${b.startTime}\u2013${b.endTime} \u00b7 ${b.user||'\u2014'}</div></div>
        <span class="res-badge ${b.resource}">${b.resource==='boardroom'?'Room':'Car'}</span>
      </div>
      <div class="admin-bk-actions">
        <button class="btn-xs move" onclick="openMoveModal('${b._key}')">Move</button>
        <button class="btn-xs swap" onclick="openSwapModal('${b._key}')">Swap</button>
        <button class="btn-xs del" onclick="deleteBooking('${b._key}',false)">Delete</button>
        ${hasSeries?`<button class="btn-xs del-series" onclick="deleteBooking('${b._key}',true)">Del Series</button>`:''}
      </div>
    </div>`;
  }).join('');
  return`<div class="admin-section-hdr"><h3>Bookings (${S.bookings.length})</h3><button class="btn-add" onclick="openBookModal(null,null)">\uff0b New</button></div>${cards||'<div style="text-align:center;padding:40px;color:var(--muted);">No bookings yet</div>'}`;
}
function renderAdminUsers(){
  const cards=S.users.map(u=>`
    <div class="user-card">
      <div class="uc-av">${initials(u.name)}</div>
      <div class="uc-info"><div class="uc-name">${u.name}</div><div class="uc-dept">${u.department||'\u2014'} \u00b7 ${u.role==='dept'?'Dept':'Individual'}</div></div>
      <div class="uc-actions">
        <button class="btn-xs move" onclick="editUser('${u._key}')">Edit</button>
        <button class="btn-xs del" onclick="adminDeleteUser('${u._key}')">Del</button>
      </div>
    </div>`).join('');
  return`<div class="admin-section-hdr"><h3>Users (${S.users.length})</h3><button class="btn-add" onclick="openAddUserModal()">\uff0b Add</button></div>${cards}`;
}
function renderAdminAdmins(){
  const cards=S.admins.map(a=>`
    <div class="user-card">
      <div class="uc-av" style="background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--navy);">${initials(a.name)}</div>
      <div class="uc-info"><div class="uc-name">${a.name}</div><div class="uc-dept">@${a.username}</div></div>
      <div class="uc-actions">
        <button class="btn-xs move" onclick="editAdminEntry('${a._key}')">Edit</button>
        <button class="btn-xs del" onclick="adminDeleteAdmin('${a._key}')">Del</button>
      </div>
    </div>`).join('');
  return`<div class="admin-section-hdr"><h3>Admins (${S.admins.length})</h3><button class="btn-add" onclick="openAddAdminModal()">\uff0b Add</button></div>${cards}`;
}
function renderDeptPasswords(){
  const depts=[...new Set(S.users.map(u=>u.department))].filter(Boolean).sort();
  const cards=depts.map(dept=>{
    const current=S.deptPasswords[dept]||'';
    const memberCount=S.users.filter(u=>u.department===dept).length;
    const safeId='deptpass-'+dept.replace(/[^a-zA-Z0-9]/g,'_');
    return`<div class="user-card" style="flex-direction:column;align-items:stretch;gap:10px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="uc-av" style="background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--navy);">${dept.slice(0,2).toUpperCase()}</div>
        <div class="uc-info"><div class="uc-name">${dept}</div><div class="uc-dept">${memberCount} member${memberCount!==1?'s':''}</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input class="form-input" style="flex:1;font-size:var(--sz-sm);" type="text" id="${safeId}" value="${current}" placeholder="Set department password\u2026">
        <button class="btn-xs move" onclick="saveDeptPassword('${dept.replace(/'/g,"\\'")}','${dept.replace(/[^a-zA-Z0-9]/g,'_')}')">Save</button>
      </div>
    </div>`;
  }).join('');
  return`<div class="admin-section-hdr"><h3>Dept Passwords</h3></div>
    <div style="font-size:var(--sz-sm);color:var(--muted);margin-bottom:var(--sp-sm);line-height:1.55;">
      Each department shares one password. Members log in with their email + this shared password.
    </div>
    ${cards||'<div style="text-align:center;padding:40px;color:var(--muted);">No departments \u2014 add users first.</div>'}`;
}
async function saveDeptPassword(dept,safeKey){
  const val=document.getElementById('deptpass-'+safeKey)?.value?.trim();
  if(!val){notify('Password cannot be empty.');return;}
  await db.ref('deptPasswords/'+dept).set(val);
  notify('Password saved for '+dept+' \u2713');
}

function openAddUserModal(){document.getElementById('add-user-title').textContent='Add User';document.getElementById('edit-user-key').value='';document.getElementById('user-name').value='';document.getElementById('user-email').value='';document.getElementById('user-dept').value='';document.getElementById('user-role').value='individual';openModal('modal-add-user');}
function editUser(key){const u=S.users.find(x=>x._key===key);if(!u)return;document.getElementById('add-user-title').textContent='Edit User';document.getElementById('edit-user-key').value=key;document.getElementById('user-name').value=u.name;document.getElementById('user-email').value=u.email||'';document.getElementById('user-dept').value=u.department||'';document.getElementById('user-role').value=u.role||'individual';openModal('modal-add-user');}
async function saveUser(){
  const key=document.getElementById('edit-user-key').value,name=document.getElementById('user-name').value.trim(),email=document.getElementById('user-email').value.trim(),dept=document.getElementById('user-dept').value.trim(),role=document.getElementById('user-role').value;
  if(!name){alert('Name required.');return;}
  const data={name,email,department:dept,role};
  if(key)await db.ref('users/'+key).update(data);else{data.id=uid();await db.ref('users').push(data);}
  populateAttendeeDropdowns();closeModal('modal-add-user');notify('User saved \u2713');
}
async function adminDeleteUser(key){if(!confirm('Delete this user?'))return;await db.ref('users/'+key).remove();notify('User deleted \u2713');}
function openAddAdminModal(){document.getElementById('add-admin-title').textContent='Add Admin';document.getElementById('edit-admin-key').value='';document.getElementById('admin-name-input').value='';document.getElementById('admin-username-input').value='';document.getElementById('admin-password-input').value='';openModal('modal-add-admin');}
function editAdminEntry(key){const a=S.admins.find(x=>x._key===key);if(!a)return;document.getElementById('add-admin-title').textContent='Edit Admin';document.getElementById('edit-admin-key').value=key;document.getElementById('admin-name-input').value=a.name;document.getElementById('admin-username-input').value=a.username;document.getElementById('admin-password-input').value=a.password||'';openModal('modal-add-admin');}
async function saveAdmin(){
  const key=document.getElementById('edit-admin-key').value,name=document.getElementById('admin-name-input').value.trim(),uname=document.getElementById('admin-username-input').value.trim(),pass=document.getElementById('admin-password-input').value.trim();
  if(!name||!uname||!pass){alert('All fields required.');return;}
  const data={name,username:uname,password:pass};
  if(key)await db.ref('admins/'+key).update(data);else await db.ref('admins').push(data);
  closeModal('modal-add-admin');notify('Admin saved \u2713');
}
async function adminDeleteAdmin(key){if(S.admins.length<=1){alert('Cannot delete last admin.');return;}if(!confirm('Delete admin?'))return;await db.ref('admins/'+key).remove();notify('Admin deleted \u2713');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){const el=document.getElementById(id);if(!el)return;el.style.display='flex';requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add('open')));}
function closeModal(id){const el=document.getElementById(id);if(!el)return;el.classList.remove('open');setTimeout(()=>{if(!el.classList.contains('open'))el.style.display='none';},400);}
function handleOverlayClick(e,id){if(e.target===document.getElementById(id))closeModal(id);}
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.overlay.open').forEach(o=>closeModal(o.id));});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifTimer;
function notify(msg){
  const el=document.getElementById('notif');
  el.textContent='';
  const icon=document.createElement('span');
  icon.textContent='\u2713';
  icon.style.cssText='background:var(--gold);color:var(--navy);width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;';
  const txt=document.createElement('span');txt.textContent=msg;
  el.appendChild(icon);el.appendChild(txt);
  el.style.animation='none';el.offsetHeight;
  el.style.display='flex';
  el.style.animation='notifIn .4s cubic-bezier(.22,.68,0,1.2) forwards';
  clearTimeout(notifTimer);
  notifTimer=setTimeout(()=>{el.style.animation='notifOut .3s ease forwards';setTimeout(()=>el.style.display='none',300);},3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initials(name){return(name||'?').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}

const _ks=document.createElement('style');
_ks.textContent=`
@keyframes notifIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes notifOut{from{opacity:1}to{opacity:0;transform:translateY(10px)}}
`;
document.head.appendChild(_ks);
</script>
</body>
</html>
