<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Executive Booking System</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOKENS & RESET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --navy:        #0d2136;
  --navy-light:  #1a3550;
  --gold:        #a8935a;
  --soft-gold:   #d6cab0;
  --beige:       #d8d0c6;
  --lt-beige:    #e6e1da;
  --cream:       #f4f2ef;
  --grey:        #d3d6d9;
  --blue-grey:   #8a949e;
  --green:       #81845a;
  --dk-green:    #2f3527;
  --teal:        #004551;
  --dk-teal:     #002937;
  --plum:        #7e2138;
  --dk-plum:     #512137;
  --white:       #ffffff;
  --danger:      #c0392b;
  --shadow-sm:   0 2px 12px rgba(13,33,54,.08);
  --shadow-md:   0 8px 32px rgba(13,33,54,.14);
  --shadow-lg:   0 24px 60px rgba(13,33,54,.22);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;font-family:'Libre Franklin',sans-serif;color:var(--navy);background:var(--cream);}
h1,h2,h3,h4,h5,.serif{font-family:'Georgia',serif;font-weight:normal;}
button{cursor:pointer;font-family:'Libre Franklin',sans-serif;transition:all .18s ease;}
button:active{transform:scale(.97);}
input,select,textarea{font-family:'Libre Franklin',sans-serif;color:var(--navy);}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--lt-beige);}
::-webkit-scrollbar-thumb{background:var(--soft-gold);border-radius:4px;}

/* ‚îÄ‚îÄ‚îÄ SCREEN MANAGEMENT ‚îÄ‚îÄ‚îÄ */
.screen{display:none;position:fixed;inset:0;z-index:100;}
.screen.active{display:flex;}
#loading-screen{background:linear-gradient(135deg,var(--navy),var(--dk-teal));align-items:center;justify-content:center;flex-direction:column;gap:20px;}
.spinner{width:44px;height:44px;border:3px solid rgba(168,147,90,.3);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:var(--soft-gold);font-size:13px;letter-spacing:3px;text-transform:uppercase;}

/* ‚îÄ‚îÄ‚îÄ PORTAL SELECTION ‚îÄ‚îÄ‚îÄ */
#portal-screen{background:linear-gradient(145deg,var(--navy) 0%,var(--dk-teal) 60%,var(--dk-plum) 100%);align-items:center;justify-content:center;flex-direction:column;overflow-y:auto;}
.portal-deco{position:absolute;border-radius:50%;border:1px solid rgba(168,147,90,.1);}
.portal-deco-1{width:600px;height:600px;top:-200px;right:-200px;}
.portal-deco-2{width:400px;height:400px;bottom:-150px;left:-100px;}
.portal-deco-3{width:200px;height:200px;top:30%;left:5%;}
.portal-inner{text-align:center;width:90%;max-width:860px;position:relative;z-index:1;padding:40px 0;}
.portal-logo-wrap{margin-bottom:32px;}
.portal-logo{width:96px;height:96px;border-radius:22px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));margin:0 auto;display:flex;align-items:center;justify-content:center;box-shadow:0 20px 50px rgba(0,0,0,.35),0 0 0 1px rgba(168,147,90,.4);}
.portal-logo svg{width:52px;height:52px;}
.portal-divider{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:10px;}
.portal-divider-line{height:1px;width:50px;background:linear-gradient(to right,transparent,var(--gold));}
.portal-divider-line.right{background:linear-gradient(to left,transparent,var(--gold));}
.portal-kicker{color:var(--gold);font-size:11px;letter-spacing:4px;text-transform:uppercase;font-weight:500;}
.portal-title{color:var(--white);font-size:clamp(28px,4vw,44px);margin-bottom:8px;letter-spacing:-.5px;}
.portal-sub{color:var(--blue-grey);font-size:14px;margin-bottom:48px;font-weight:300;}
.portal-cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:600px){.portal-cards{grid-template-columns:1fr;}}
.portal-card{background:rgba(255,255,255,.06);backdrop-filter:blur(12px);border:1px solid rgba(168,147,90,.25);border-radius:20px;padding:40px 28px;transition:all .3s ease;text-align:left;cursor:pointer;}
.portal-card:hover{background:rgba(168,147,90,.12);border-color:var(--gold);transform:translateY(-4px);box-shadow:0 20px 50px rgba(0,0,0,.3);}
.portal-card-icon{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;font-size:22px;}
.portal-card-icon.admin{background:linear-gradient(135deg,var(--gold),var(--soft-gold));}
.portal-card-icon.user{background:linear-gradient(135deg,var(--teal),var(--dk-teal));}
.portal-card h2{color:var(--white);font-size:22px;margin-bottom:8px;}
.portal-card p{color:var(--blue-grey);font-size:13px;line-height:1.6;}
.portal-footer{color:rgba(138,148,158,.4);font-size:11px;margin-top:40px;letter-spacing:.5px;}

/* ‚îÄ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ‚îÄ */
.modal-screen{background:rgba(13,33,54,.9);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:200;}
.modal-box{background:var(--white);border-radius:24px;width:90%;max-width:480px;padding:40px;border:1px solid var(--gold);box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;position:relative;}
.modal-box.wide{max-width:640px;}
.modal-back{position:absolute;top:16px;left:16px;background:transparent;border:1px solid var(--grey);color:var(--blue-grey);border-radius:8px;padding:7px 14px;font-size:12px;}
.modal-back:hover{background:var(--cream);color:var(--navy);}
.modal-logo{display:flex;justify-content:center;margin-bottom:24px;}
.modal-box h2{text-align:center;color:var(--navy);font-size:26px;margin-bottom:6px;}
.modal-box .subtitle{text-align:center;color:var(--blue-grey);font-size:13px;margin-bottom:32px;}

/* ‚îÄ‚îÄ‚îÄ USER SELECTION ‚îÄ‚îÄ‚îÄ */
.user-list{max-height:420px;overflow-y:auto;}
.dept-group{margin-bottom:20px;}
.dept-label{background:var(--navy);color:var(--gold);padding:8px 14px;border-radius:8px;font-size:11px;letter-spacing:2px;text-transform:uppercase;font-weight:600;margin-bottom:8px;}
.user-option{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--cream);border:2px solid transparent;border-radius:12px;margin-bottom:6px;cursor:pointer;transition:all .2s ease;}
.user-option:hover{border-color:var(--gold);background:var(--white);transform:translateX(4px);}
.u-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--dk-teal));color:var(--white);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;}
.u-name{font-weight:600;color:var(--navy);font-size:14px;}
.u-dept{font-size:12px;color:var(--blue-grey);}

/* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
#app{display:none;flex-direction:row;height:100vh;}
#app.active{display:flex;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{width:220px;background:var(--navy);flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid rgba(168,147,90,.18);}
.sidebar-logo{padding:20px 18px;border-bottom:1px solid rgba(168,147,90,.12);display:flex;align-items:center;gap:12px;}
.sidebar-logo-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sidebar-logo-icon svg{width:22px;height:22px;}
.sidebar-brand{overflow:hidden;}
.sidebar-brand h1{color:var(--white);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar-brand span{color:var(--gold);font-size:10px;letter-spacing:2px;text-transform:uppercase;}
.sidebar-user{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;}
.sidebar-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--dk-teal));color:var(--white);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;}
.sidebar-avatar.admin-av{background:linear-gradient(135deg,var(--gold),var(--soft-gold));color:var(--navy);}
.sidebar-user-info{overflow:hidden;}
.sidebar-user-name{color:var(--white);font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar-user-role{color:var(--blue-grey);font-size:11px;}
.sidebar-nav{flex:1;padding:14px 10px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;color:var(--blue-grey);font-size:13px;font-weight:400;border:1px solid transparent;background:transparent;width:100%;text-align:left;margin-bottom:3px;}
.nav-item:hover{background:rgba(255,255,255,.06);color:var(--soft-gold);}
.nav-item.active{background:rgba(168,147,90,.16);border-color:rgba(168,147,90,.28);color:var(--soft-gold);font-weight:600;}
.nav-item .nav-icon{font-size:15px;width:18px;text-align:center;}
.sidebar-resources{margin:10px 10px 0;background:rgba(168,147,90,.07);border-radius:10px;padding:12px 14px;}
.sidebar-resources .sr-label{color:var(--gold);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.sr-item{display:flex;align-items:center;gap:8px;color:var(--blue-grey);font-size:12px;margin-bottom:5px;}
.sr-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0;}
.sidebar-bottom{padding:12px 10px;}
.sidebar-live{display:flex;align-items:center;gap:6px;padding:8px 14px;color:var(--green);font-size:11px;font-weight:600;margin-bottom:4px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.btn-signout{width:100%;padding:9px;background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--blue-grey);font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px;}
.btn-signout:hover{background:rgba(255,255,255,.06);color:var(--soft-gold);}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{padding:14px 28px;background:var(--white);border-bottom:1px solid var(--grey);display:flex;align-items:center;gap:16px;flex-shrink:0;flex-wrap:wrap;}
.resource-tabs{display:flex;gap:4px;background:var(--cream);border-radius:10px;padding:4px;}
.res-tab{padding:8px 18px;border-radius:7px;border:none;background:transparent;color:var(--blue-grey);font-size:13px;font-weight:500;display:flex;align-items:center;gap:7px;}
.res-tab.active{background:var(--navy);color:var(--white);}
.res-tab .res-dot{width:7px;height:7px;border-radius:2px;display:inline-block;}
.topbar-nav{display:flex;align-items:center;gap:8px;margin-left:auto;}
.btn-today{padding:7px 16px;background:var(--cream);border:1px solid var(--grey);border-radius:8px;font-size:12px;color:var(--navy);}
.btn-today:hover{background:var(--lt-beige);}
.btn-nav{width:32px;height:32px;background:var(--cream);border:1px solid var(--grey);border-radius:8px;font-size:16px;color:var(--navy);display:flex;align-items:center;justify-content:center;}
.btn-nav:hover{background:var(--lt-beige);}
.topbar-title{font-family:'Georgia',serif;font-size:16px;color:var(--navy);min-width:210px;text-align:center;}
.view-tabs{display:flex;gap:3px;background:var(--cream);border-radius:10px;padding:4px;}
.view-tab{padding:7px 14px;border-radius:7px;border:none;background:transparent;color:var(--blue-grey);font-size:12px;font-weight:500;text-transform:capitalize;}
.view-tab.active{background:var(--navy);color:var(--white);font-weight:600;}
.btn-book{padding:9px 20px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));border:none;border-radius:9px;color:var(--navy);font-size:13px;font-weight:700;flex-shrink:0;}
.btn-book:hover{filter:brightness(1.06);}

/* ‚îÄ‚îÄ‚îÄ CALENDAR AREA ‚îÄ‚îÄ‚îÄ */
.calendar-wrap{flex:1;overflow:auto;padding:20px 28px;}

/* ‚îÄ‚îÄ‚îÄ DAY / WEEK VIEWS ‚îÄ‚îÄ‚îÄ */
.time-grid{display:grid;border-radius:16px;overflow:hidden;border:1px solid var(--grey);background:var(--white);}
.tg-header{display:grid;background:var(--navy);border-bottom:2px solid var(--gold);font-size:11px;color:var(--soft-gold);letter-spacing:1.5px;text-transform:uppercase;}
.tg-header .th-time{padding:12px 10px;border-right:1px solid rgba(255,255,255,.08);}
.tg-header .th-day{padding:12px 8px;text-align:center;border-right:1px solid rgba(255,255,255,.08);}
.th-day-num{color:var(--white);font-family:'Georgia',serif;font-size:20px;line-height:1;}
.th-day-today .th-day-num{color:var(--gold);}
.th-today-dot{width:4px;height:4px;border-radius:50%;background:var(--gold);margin:4px auto 0;}
.tg-body{display:grid;position:relative;}
.tg-row{display:grid;border-bottom:1px solid var(--lt-beige);}
.time-cell{padding:4px 10px 0;text-align:right;color:var(--blue-grey);font-size:10px;border-right:1px solid var(--grey);font-weight:500;}
.day-cell{border-right:1px solid var(--lt-beige);position:relative;cursor:pointer;}
.day-cell:hover{background:rgba(168,147,90,.04);}
.day-cell.today-col{background:rgba(168,147,90,.03);}
/* Booking chip in time grid */
.bk-chip{position:absolute;left:3px;right:3px;border-radius:6px;padding:4px 7px;overflow:hidden;z-index:5;cursor:pointer;transition:filter .15s;}
.bk-chip:hover{filter:brightness(1.1);}
.bk-chip.boardroom{background:linear-gradient(135deg,var(--teal),#006375);}
.bk-chip.car{background:linear-gradient(135deg,var(--dk-plum),var(--plum));}
.bk-title{color:var(--white);font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bk-meta{color:rgba(255,255,255,.75);font-size:10px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ‚îÄ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ‚îÄ */
.month-grid{border-radius:16px;overflow:hidden;border:1px solid var(--grey);background:var(--white);}
.month-header-row{display:grid;grid-template-columns:repeat(7,1fr);background:var(--navy);border-bottom:2px solid var(--gold);}
.month-header-row .mhc{padding:12px 8px;text-align:center;color:var(--soft-gold);font-size:11px;letter-spacing:2px;text-transform:uppercase;}
.month-body{display:grid;grid-template-columns:repeat(7,1fr);}
.month-cell{min-height:110px;border-right:1px solid var(--lt-beige);border-bottom:1px solid var(--lt-beige);padding:8px 6px;cursor:pointer;transition:background .15s;}
.month-cell:hover{background:var(--cream);}
.month-cell.other-month{background:var(--cream);opacity:.55;}
.month-cell.today{background:rgba(168,147,90,.07);}
.mc-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;margin:0 auto 5px auto;font-weight:400;}
.mc-num.today-num{background:var(--gold);color:var(--white);font-weight:700;}
.mc-chip{border-radius:4px;padding:3px 6px;margin-bottom:2px;font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
.mc-chip.boardroom{background:rgba(0,69,81,.15);color:var(--teal);}
.mc-chip.car{background:rgba(126,33,56,.15);color:var(--plum);}
.mc-more{font-size:10px;color:var(--blue-grey);padding-left:4px;}

/* ‚îÄ‚îÄ‚îÄ YEAR VIEW ‚îÄ‚îÄ‚îÄ */
.year-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
@media(max-width:900px){.year-grid{grid-template-columns:repeat(3,1fr);}}
.mini-cal{background:var(--white);border-radius:12px;border:1px solid var(--grey);overflow:hidden;cursor:pointer;transition:all .2s;}
.mini-cal:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:var(--shadow-md);}
.mini-cal-hdr{background:var(--navy);padding:10px 12px;color:var(--white);font-family:'Georgia',serif;font-size:13px;display:flex;justify-content:space-between;align-items:center;}
.mini-cal-hdr .bk-count{background:var(--gold);color:var(--navy);font-size:9px;font-weight:700;border-radius:10px;padding:1px 6px;font-family:'Libre Franklin',sans-serif;}
.mini-cal-body{padding:6px 4px;}
.mini-days-hdr{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:3px;}
.mini-days-hdr span{text-align:center;font-size:8px;color:var(--blue-grey);padding:2px 0;}
.mini-days-body{display:grid;grid-template-columns:repeat(7,1fr);}
.mini-day{text-align:center;font-size:9px;padding:2px 0;border-radius:50%;margin:1px auto;width:18px;height:18px;display:flex;align-items:center;justify-content:center;}
.mini-day.has-bk{background:rgba(0,69,81,.15);color:var(--teal);font-weight:700;}
.mini-day.today-mini{background:var(--gold);color:var(--white);font-weight:700;}

/* ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ */
.admin-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.admin-topbar{padding:16px 28px 0;background:var(--white);border-bottom:1px solid var(--grey);flex-shrink:0;}
.admin-topbar h2{font-family:'Georgia',serif;color:var(--navy);font-size:22px;margin-bottom:14px;}
.admin-tabs{display:flex;gap:0;}
.admin-tab{padding:10px 22px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--blue-grey);font-size:13px;font-weight:400;}
.admin-tab.active{border-bottom-color:var(--gold);color:var(--navy);font-weight:600;}
.admin-tab:hover{color:var(--navy);}
.admin-body{flex:1;overflow:auto;padding:24px 28px;}

/* ‚îÄ‚îÄ‚îÄ ADMIN TABLES ‚îÄ‚îÄ‚îÄ */
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.section-hdr h3{font-family:'Georgia',serif;color:var(--navy);font-size:19px;}
.data-table{background:var(--white);border-radius:14px;overflow:hidden;border:1px solid var(--grey);box-shadow:var(--shadow-sm);}
.data-table table{width:100%;border-collapse:collapse;}
.data-table th{background:var(--navy);color:var(--gold);padding:12px 16px;text-align:left;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;}
.data-table td{padding:13px 16px;border-bottom:1px solid var(--lt-beige);font-size:13px;vertical-align:middle;}
.data-table tr:last-child td{border-bottom:none;}
.data-table tr:hover td{background:var(--cream);}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-gold{background:rgba(168,147,90,.15);color:var(--gold);}
.badge-teal{background:rgba(0,69,81,.12);color:var(--teal);}
.badge-plum{background:rgba(126,33,56,.12);color:var(--plum);}
.action-btns{display:flex;gap:6px;}
.btn-sm{padding:6px 12px;border:none;border-radius:7px;font-size:12px;font-weight:600;}
.btn-edit{background:var(--teal);color:var(--white);}
.btn-move{background:var(--dk-green);color:var(--white);}
.btn-swap{background:var(--plum);color:var(--white);}
.btn-del{background:var(--danger);color:var(--white);}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(13,33,54,.6);backdrop-filter:blur(5px);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.open{display:flex;}
.modal{background:var(--white);border-radius:22px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);border:1px solid var(--gold);}
.modal.modal-sm{max-width:440px;}
.modal-hdr{padding:24px 28px;border-radius:22px 22px 0 0;display:flex;justify-content:space-between;align-items:flex-start;}
.modal-hdr.navy{background:linear-gradient(135deg,var(--navy),var(--navy-light));}
.modal-hdr.teal{background:linear-gradient(135deg,var(--teal),var(--dk-teal));}
.modal-hdr.plum{background:linear-gradient(135deg,var(--plum),var(--dk-plum));}
.modal-hdr.gold{background:linear-gradient(135deg,var(--gold),var(--soft-gold));}
.modal-hdr h3{font-family:'Georgia',serif;font-size:20px;}
.modal-hdr.navy h3,.modal-hdr.teal h3,.modal-hdr.plum h3{color:var(--white);}
.modal-hdr.gold h3{color:var(--navy);}
.modal-hdr p{font-size:12px;margin-top:3px;opacity:.75;}
.modal-hdr.navy p,.modal-hdr.teal p,.modal-hdr.plum p{color:var(--soft-gold);}
.modal-hdr.gold p{color:var(--navy);}
.btn-close{width:34px;height:34px;border-radius:8px;border:none;background:rgba(255,255,255,.15);color:var(--white);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.btn-close.dark{background:var(--lt-beige);color:var(--navy);}
.modal-body{padding:24px 28px;}
.form-group{margin-bottom:18px;}
.form-label{display:block;font-size:11px;color:var(--blue-grey);margin-bottom:6px;letter-spacing:1px;text-transform:uppercase;font-weight:600;}
.form-input,.form-select{width:100%;padding:10px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--cream);transition:border-color .18s;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--gold);background:var(--white);box-shadow:0 0 0 3px rgba(168,147,90,.12);}
.form-textarea{width:100%;padding:10px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--cream);resize:vertical;min-height:70px;font-family:'Libre Franklin',sans-serif;}
.form-textarea:focus{outline:none;border-color:var(--gold);}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.toggle-group{display:flex;gap:8px;}
.toggle-btn{flex:1;padding:9px;border:2px solid var(--grey);border-radius:8px;background:transparent;font-size:13px;color:var(--blue-grey);font-weight:500;}
.toggle-btn.active{border-color:var(--gold);background:rgba(168,147,90,.1);color:var(--navy);font-weight:600;}
.recurrence-row{display:flex;gap:6px;flex-wrap:wrap;}
.rec-btn{padding:7px 14px;border:2px solid var(--grey);border-radius:8px;background:transparent;font-size:12px;color:var(--blue-grey);}
.rec-btn.active{border-color:var(--teal);background:rgba(0,69,81,.08);color:var(--teal);font-weight:600;}
.attendees-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
.att-tag{background:rgba(0,69,81,.1);color:var(--teal);border-radius:20px;padding:4px 10px;font-size:12px;display:flex;align-items:center;gap:5px;}
.att-tag button{background:none;border:none;color:var(--teal);font-size:14px;line-height:1;padding:0;}
.add-att-row{display:flex;gap:8px;margin-top:8px;}
.add-att-row .form-input{flex:1;}
.conflict-warn{background:rgba(126,33,56,.1);border:1px solid var(--plum);color:var(--plum);padding:10px 14px;border-radius:9px;font-size:13px;margin-bottom:14px;display:none;}
.conflict-warn.visible{display:block;}
.error-msg{background:rgba(192,57,43,.1);border:1px solid var(--danger);color:var(--danger);padding:10px 14px;border-radius:9px;font-size:13px;margin-bottom:14px;display:none;}
.error-msg.visible{display:block;}
.info-card{background:var(--cream);border-radius:9px;padding:12px 16px;margin-bottom:10px;}
.info-card .ic-label{font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.info-card .ic-val{color:var(--navy);font-weight:500;font-size:13px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.modal-footer{display:flex;gap:10px;margin-top:22px;}
.modal-footer .btn-prim{flex:1;padding:11px;background:linear-gradient(135deg,var(--gold),var(--soft-gold));border:none;border-radius:9px;color:var(--navy);font-size:13px;font-weight:700;}
.modal-footer .btn-prim:hover{filter:brightness(1.06);}
.modal-footer .btn-prim.teal{background:linear-gradient(135deg,var(--teal),var(--dk-teal));color:var(--white);}
.modal-footer .btn-prim.plum{background:linear-gradient(135deg,var(--plum),var(--dk-plum));color:var(--white);}
.modal-footer .btn-sec{flex:1;padding:11px;background:var(--lt-beige);border:1px solid var(--grey);border-radius:9px;color:var(--blue-grey);font-size:13px;}

/* ‚îÄ‚îÄ‚îÄ BOOKING DETAIL ‚îÄ‚îÄ‚îÄ */
.detail-res-hdr{border-radius:14px 14px 0 0;padding:24px;position:relative;overflow:hidden;}
.detail-res-hdr::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08);}
.detail-res-hdr.boardroom{background:linear-gradient(135deg,var(--teal),#006375);}
.detail-res-hdr.car{background:linear-gradient(135deg,var(--dk-plum),var(--plum));}
.detail-kicker{color:rgba(255,255,255,.65);font-size:11px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
.detail-title{color:var(--white);font-family:'Georgia',serif;font-size:22px;line-height:1.2;}

/* ‚îÄ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ */
.notif{position:fixed;bottom:28px;right:28px;background:var(--navy);color:var(--white);padding:14px 22px;border-radius:12px;border-left:4px solid var(--gold);box-shadow:var(--shadow-md);font-size:13px;font-weight:600;z-index:9999;transform:translateY(10px);opacity:0;transition:all .3s ease;}
.notif.show{opacity:1;transform:translateY(0);}

/* ‚îÄ‚îÄ‚îÄ FORM TIME DIAL ‚îÄ‚îÄ‚îÄ */
.time-dials{display:flex;align-items:center;justify-content:center;gap:24px;background:var(--cream);padding:20px;border-radius:14px;border:1px solid var(--grey);}
.dial{text-align:center;}
.dial-label{font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;}
.dial-face{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--dk-teal));color:var(--white);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;margin:0 auto 10px;box-shadow:0 4px 20px rgba(13,33,54,.3);}
.dial-controls{display:flex;gap:8px;justify-content:center;}
.dial-btn{width:32px;height:32px;border-radius:50%;border:2px solid var(--grey);background:var(--white);color:var(--navy);font-size:16px;display:flex;align-items:center;justify-content:center;}
.dial-btn:hover{border-color:var(--gold);background:var(--gold);color:var(--navy);}
.dial-sep{font-size:24px;font-weight:700;color:var(--navy);margin-top:-16px;}

/* ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:60px 20px;color:var(--blue-grey);}
.empty-state .es-icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:14px;}
.fade-in{animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.logo-ph{display:flex;align-items:center;justify-content:center;}
.search-bar{width:100%;padding:9px 14px;border:1px solid var(--grey);border-radius:9px;font-size:13px;background:var(--white);margin-bottom:16px;}
.search-bar:focus{outline:none;border-color:var(--gold);}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOADING SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading-screen" class="screen active">
  <div class="portal-logo" style="margin-bottom:24px;">
    <svg viewBox="0 0 52 52" fill="none"><rect x="4" y="4" width="20" height="20" rx="4" fill="#0d2136"/><rect x="28" y="4" width="20" height="20" rx="4" fill="#0d2136" opacity=".6"/><rect x="4" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".6"/><rect x="28" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".3"/></svg>
  </div>
  <div class="spinner"></div>
  <div class="loading-text" id="loading-msg">Connecting to database‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PORTAL SELECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="portal-screen" class="screen">
  <div class="portal-deco portal-deco-1"></div>
  <div class="portal-deco portal-deco-2"></div>
  <div class="portal-deco portal-deco-3"></div>
  <div class="portal-inner fade-in">
    <div class="portal-logo-wrap">
      <div class="portal-logo">
        <svg viewBox="0 0 52 52" fill="none"><rect x="4" y="4" width="20" height="20" rx="4" fill="#0d2136"/><rect x="28" y="4" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="4" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="28" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".4"/></svg>
      </div>
    </div>
    <div class="portal-divider">
      <div class="portal-divider-line"></div>
      <span class="portal-kicker">Workspace Portal</span>
      <div class="portal-divider-line right"></div>
    </div>
    <h1 class="portal-title">Reserve &amp; Schedule</h1>
    <p class="portal-sub">Select your access level to continue</p>
    <div class="portal-cards">
      <div class="portal-card" onclick="selectPortal('admin')">
        <div class="portal-card-icon admin">üîê</div>
        <h2>Admin Portal</h2>
        <p>Manage users, departments, and all bookings. Move, swap or cancel any reservation.</p>
      </div>
      <div class="portal-card" onclick="selectPortal('user')">
        <div class="portal-card-icon user">üìÖ</div>
        <h2>User Portal</h2>
        <p>Book the board room or company car. View live schedules and manage your reservations.</p>
      </div>
    </div>
    <p class="portal-footer">¬© <span id="yr"></span> Executive Booking System ‚Äî Powered by Firebase</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="admin-login-screen" class="screen modal-screen">
  <div class="modal-box">
    <button class="modal-back" onclick="showScreen('portal-screen')">‚Üê Back</button>
    <div class="modal-logo"><div class="portal-logo" style="width:64px;height:64px;border-radius:16px;"><svg viewBox="0 0 52 52" fill="none"><rect x="4" y="4" width="20" height="20" rx="4" fill="#0d2136"/><rect x="28" y="4" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="4" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="28" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".4"/></svg></div></div>
    <h2>Admin Login</h2>
    <p class="subtitle">Enter your credentials to access the admin portal</p>
    <div class="error-msg" id="login-error">Invalid username or password.</div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input class="form-input" id="admin-user" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input class="form-input" id="admin-pass" type="password" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doAdminLogin()">
    </div>
    <button class="btn-book" style="width:100%;padding:13px;" onclick="doAdminLogin()" id="login-btn">Login to Admin Portal</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     USER SELECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="user-select-screen" class="screen modal-screen">
  <div class="modal-box wide">
    <button class="modal-back" onclick="showScreen('portal-screen')">‚Üê Back</button>
    <div class="modal-logo"><div class="portal-logo" style="width:64px;height:64px;border-radius:16px;"><svg viewBox="0 0 52 52" fill="none"><rect x="4" y="4" width="20" height="20" rx="4" fill="#0d2136"/><rect x="28" y="4" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="4" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="28" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".4"/></svg></div></div>
    <h2>Select Your Profile</h2>
    <p class="subtitle">Choose your name to access the booking portal</p>
    <div class="user-list" id="user-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon"><svg viewBox="0 0 52 52" fill="none"><rect x="4" y="4" width="20" height="20" rx="4" fill="#0d2136"/><rect x="28" y="4" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="4" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".7"/><rect x="28" y="28" width="20" height="20" rx="4" fill="#0d2136" opacity=".4"/></svg></div>
      <div class="sidebar-brand"><h1>Reserve &amp; Schedule</h1><span>Workspace Portal</span></div>
    </div>
    <div class="sidebar-user">
      <div class="sidebar-avatar" id="sb-avatar">U</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sb-name">User</div>
        <div class="sidebar-user-role" id="sb-role">User</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item active" id="nav-calendar" onclick="switchPanel('calendar')">
        <span class="nav-icon">üìÖ</span> Calendar
      </button>
      <button class="nav-item" id="nav-admin" onclick="switchPanel('admin')" style="display:none;">
        <span class="nav-icon">‚öôÔ∏è</span> Admin Panel
      </button>
    </nav>
    <div class="sidebar-resources">
      <div class="sr-label">Resources</div>
      <div class="sr-item"><div class="sr-dot" style="background:#004551;"></div> Board Room</div>
      <div class="sr-item"><div class="sr-dot" style="background:#7e2138;"></div> Company Car</div>
    </div>
    <div class="sidebar-bottom">
      <div class="sidebar-live" id="sb-live" style="display:none;"><div class="live-dot"></div> Live Sync</div>
      <button class="btn-signout" onclick="doLogout()">‚Üê Sign Out</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- CALENDAR PANEL -->
    <div id="panel-calendar">
      <div class="topbar">
        <div class="resource-tabs">
          <button class="res-tab active" id="tab-boardroom" onclick="switchResource('boardroom')">
            <span class="res-dot" style="background:#004551;"></span> Board Room
          </button>
          <button class="res-tab" id="tab-car" onclick="switchResource('car')">
            <span class="res-dot" style="background:#7e2138;"></span> Company Car
          </button>
        </div>
        <div class="topbar-nav">
          <button class="btn-today" onclick="goToday()">Today</button>
          <button class="btn-nav" onclick="navPrev()">‚Äπ</button>
          <button class="btn-nav" onclick="navNext()">‚Ä∫</button>
          <div class="topbar-title serif" id="cal-title">‚Äî</div>
        </div>
        <div class="view-tabs">
          <button class="view-tab" onclick="switchView('day')">Day</button>
          <button class="view-tab active" onclick="switchView('week')">Week</button>
          <button class="view-tab" onclick="switchView('month')">Month</button>
          <button class="view-tab" onclick="switchView('year')">Year</button>
        </div>
        <button class="btn-book" onclick="openBookModal(null,null)">Ôºã New Booking</button>
      </div>
      <div class="calendar-wrap" id="calendar-wrap"></div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="panel-admin" style="display:none;" class="admin-wrap">
      <div class="admin-topbar">
        <h2>Administration</h2>
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="showAdminTab('bookings')">All Bookings</button>
          <button class="admin-tab" onclick="showAdminTab('users')">Users</button>
          <button class="admin-tab" onclick="showAdminTab('admins')">Admins</button>
        </div>
      </div>
      <div class="admin-body fade-in" id="admin-body"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- BOOKING MODAL -->
<div class="overlay" id="modal-book">
  <div class="modal fade-in">
    <div class="modal-hdr navy">
      <div><h3>New Booking</h3><p>Reserve your workspace</p></div>
      <button class="btn-close" onclick="closeModal('modal-book')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="conflict-warn" id="bk-conflict">‚ö†Ô∏è This time slot conflicts with an existing booking.</div>
      <div class="error-msg" id="bk-error"></div>
      <div class="form-group">
        <label class="form-label">Resource</label>
        <div class="toggle-group">
          <button class="toggle-btn active" id="bk-res-boardroom" onclick="setBkResource('boardroom')">üè¢ Board Room</button>
          <button class="toggle-btn" id="bk-res-car" onclick="setBkResource('car')">üöó Company Car</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Booking Title / Purpose</label>
        <input class="form-input" id="bk-purpose" placeholder="e.g. Q3 Strategy Meeting">
      </div>
      <div class="form-group">
        <label class="form-label">Book As</label>
        <div class="toggle-group">
          <button class="toggle-btn active" id="bk-as-self" onclick="setBkAs('self')">üë§ Myself</button>
          <button class="toggle-btn" id="bk-as-dept" onclick="setBkAs('dept')">üè¢ My Department</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" type="date" id="bk-date" onchange="checkConflict()">
      </div>
      <div class="form-group">
        <label class="form-label">Time</label>
        <div class="time-dials">
          <div class="dial">
            <div class="dial-label">Start</div>
            <div class="dial-face" id="dial-start">09:00</div>
            <div class="dial-controls">
              <button class="dial-btn" onclick="adjustTime('start',-30)">‚àí</button>
              <button class="dial-btn" onclick="adjustTime('start',30)">+</button>
            </div>
          </div>
          <div class="dial-sep">‚Üí</div>
          <div class="dial">
            <div class="dial-label">End</div>
            <div class="dial-face" id="dial-end">10:00</div>
            <div class="dial-controls">
              <button class="dial-btn" onclick="adjustTime('end',-30)">‚àí</button>
              <button class="dial-btn" onclick="adjustTime('end',30)">+</button>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Attendees (optional)</label>
        <div class="add-att-row">
          <select class="form-select" id="att-user-sel" style="flex:1;">
            <option value="">Add a person‚Ä¶</option>
          </select>
          <button class="btn-sm btn-edit" onclick="addAttendeeFromUser()">Ôºã</button>
          <select class="form-select" id="att-dept-sel" style="flex:1;">
            <option value="">Add a department‚Ä¶</option>
          </select>
          <button class="btn-sm btn-edit" onclick="addAttendeeFromDept()">Ôºã</button>
        </div>
        <div class="attendees-wrap" id="attendees-wrap"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Recurrence</label>
        <div class="recurrence-row">
          <button class="rec-btn active" id="rec-once" onclick="setRecurrence('once')">Once</button>
          <button class="rec-btn" id="rec-daily" onclick="setRecurrence('daily')">Daily</button>
          <button class="rec-btn" id="rec-weekdays" onclick="setRecurrence('weekdays')">Weekdays</button>
          <button class="rec-btn" id="rec-weekly" onclick="setRecurrence('weekly')">Weekly</button>
          <button class="rec-btn" id="rec-monthly" onclick="setRecurrence('monthly')">Monthly</button>
        </div>
        <div id="rec-count-wrap" style="display:none;margin-top:10px;display:flex;align-items:center;gap:10px;">
          <span style="font-size:13px;color:var(--blue-grey);">Repeat</span>
          <input class="form-input" type="number" id="rec-count" value="4" min="2" max="52" style="width:80px;text-align:center;">
          <span style="font-size:13px;color:var(--blue-grey);" id="rec-count-label">times</span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="bk-notes" placeholder="Any additional notes‚Ä¶"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveBooking()" id="bk-submit-btn">Confirm Booking</button>
        <button class="btn-sec" onclick="closeModal('modal-book')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- BOOKING DETAIL MODAL -->
<div class="overlay" id="modal-detail">
  <div class="modal modal-sm fade-in">
    <div id="detail-hdr" class="detail-res-hdr boardroom">
      <button class="btn-close" style="position:absolute;top:16px;right:16px;" onclick="closeModal('modal-detail')">√ó</button>
      <div class="detail-kicker" id="detail-resource-label">Board Room</div>
      <div class="detail-title" id="detail-title">‚Äî</div>
    </div>
    <div class="modal-body">
      <div class="info-grid" id="detail-info-grid"></div>
      <div id="detail-attendees-wrap" style="margin-bottom:14px;display:none;">
        <div class="ic-label" style="font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Attendees</div>
        <div class="attendees-wrap" id="detail-attendees"></div>
      </div>
      <div id="detail-notes" style="display:none;background:var(--cream);border-left:3px solid var(--gold);padding:10px 14px;border-radius:0 8px 8px 0;font-size:13px;margin-bottom:14px;"></div>
      <div class="modal-footer" id="detail-actions"></div>
    </div>
  </div>
</div>

<!-- MOVE MODAL -->
<div class="overlay" id="modal-move">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr teal"><div><h3>Move Booking</h3><p>Change the date and time</p></div><button class="btn-close" onclick="closeModal('modal-move')">√ó</button></div>
    <div class="modal-body">
      <div class="info-card" id="move-booking-info"></div>
      <div class="form-group">
        <label class="form-label">New Date</label>
        <input class="form-input" type="date" id="move-date">
      </div>
      <div class="form-group">
        <label class="form-label">New Start Time</label>
        <input class="form-input" type="time" id="move-start" step="1800">
      </div>
      <div class="form-group">
        <label class="form-label">New End Time</label>
        <input class="form-input" type="time" id="move-end" step="1800">
      </div>
      <div class="modal-footer">
        <button class="btn-prim teal" onclick="confirmMove()">Move Booking</button>
        <button class="btn-sec" onclick="closeModal('modal-move')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- SWAP MODAL -->
<div class="overlay" id="modal-swap">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr plum"><div><h3>Swap Bookings</h3><p>Exchange time slots between two bookings</p></div><button class="btn-close" onclick="closeModal('modal-swap')">√ó</button></div>
    <div class="modal-body">
      <div style="margin-bottom:16px;">
        <div class="ic-label" style="font-size:10px;color:var(--blue-grey);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Booking A</div>
        <div class="info-card" id="swap-a-info"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Select Booking B (to swap with)</label>
        <select class="form-select" id="swap-b-sel"></select>
      </div>
      <div class="modal-footer">
        <button class="btn-prim plum" onclick="confirmSwap()">Swap Times</button>
        <button class="btn-sec" onclick="closeModal('modal-swap')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD USER MODAL -->
<div class="overlay" id="modal-add-user">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr gold"><div><h3 id="add-user-title">Add New User</h3><p>Fill in the user's details</p></div><button class="btn-close dark" onclick="closeModal('modal-add-user')">√ó</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-user-key">
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="user-name" placeholder="e.g. Alexandra Morgan"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="user-email" type="email" placeholder="name@company.com"></div>
      <div class="form-group">
        <label class="form-label">Department</label>
        <input class="form-input" id="user-dept" placeholder="e.g. Finance">
      </div>
      <div class="form-group">
        <label class="form-label">Account Type</label>
        <select class="form-select" id="user-role">
          <option value="individual">Individual</option>
          <option value="dept">Department Account</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveUser()">Save User</button>
        <button class="btn-sec" onclick="closeModal('modal-add-user')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD ADMIN MODAL -->
<div class="overlay" id="modal-add-admin">
  <div class="modal modal-sm fade-in">
    <div class="modal-hdr navy"><div><h3 id="add-admin-title">Add Admin User</h3><p>Create administrator credentials</p></div><button class="btn-close" onclick="closeModal('modal-add-admin')">√ó</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-admin-key">
      <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="admin-name-input" placeholder="e.g. System Administrator"></div>
      <div class="form-group"><label class="form-label">Username</label><input class="form-input" id="admin-username-input" placeholder="e.g. admin"></div>
      <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="admin-password-input" type="password" placeholder="Set a password"></div>
      <div class="modal-footer">
        <button class="btn-prim" onclick="saveAdmin()">Save Admin</button>
        <button class="btn-sec" onclick="closeModal('modal-add-admin')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIG  ‚Üê your existing config, unchanged
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAURxQJYzXb6NSzPoN6tQibZXuCyveZoKw",
  authDomain: "executive-booking-system.firebaseapp.com",
  databaseURL: "https://executive-booking-system-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "executive-booking-system",
  storageBucket: "executive-booking-system.firebasestorage.app",
  messagingSenderId: "999349397455",
  appId: "1:999349397455:web:dd4767d1a058d7756014ba"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  users:[],bookings:[],admins:[],
  currentUser:null,isAdmin:false,
  resource:'boardroom',view:'week',
  date: new Date(),
  adminTab:'bookings',
  // booking form state
  bkResource:'boardroom',bkAs:'self',
  bkStartMin:540,bkEndMin:600,
  bkAttendees:[],bkRecurrence:'once',
  // move/swap targets
  moveTarget:null, swapTarget:null
};

document.getElementById('yr').textContent = new Date().getFullYear();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  *** THE FIX: Load Firebase data BEFORE showing any login ***
//  Both bugs (invalid credentials + timeout) were caused by
//  listeners not being set up until AFTER login ‚Äî meaning the
//  admins/users arrays were empty when login checks ran.
//  Now we load everything on page open, then show portals.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  setLoadingMsg('Connecting to database‚Ä¶');

  // Step 1: ensure default data exists (runs .once ‚Äî no cost)
  ensureDefaultData()
    .then(() => {
      setLoadingMsg('Loading workspace data‚Ä¶');
      // Step 2: set up real-time listeners ‚Äî counts how many
      // collections have fired their FIRST value event
      let ready = {users:false, bookings:false, admins:false};
      const check = () => {
        if (ready.users && ready.bookings && ready.admins) {
          // ALL data loaded ‚Äî now safe to show portal
          document.getElementById('sb-live').style.display = 'flex';
          showScreen('portal-screen');
        }
      };

      db.ref('users').on('value', snap => {
        S.users = [];
        snap.forEach(c => S.users.push({...c.val(), _key:c.key}));
        if (!ready.users) { ready.users = true; check(); }
        refreshIfNeeded('users');
      });

      db.ref('bookings').on('value', snap => {
        S.bookings = [];
        snap.forEach(c => S.bookings.push({...c.val(), _key:c.key}));
        if (!ready.bookings) { ready.bookings = true; check(); }
        refreshIfNeeded('bookings');
      });

      db.ref('admins').on('value', snap => {
        S.admins = [];
        snap.forEach(c => S.admins.push({...c.val(), _key:c.key}));
        if (!ready.admins) { ready.admins = true; check(); }
        refreshIfNeeded('admins');
      });
    })
    .catch(e => {
      setLoadingMsg('‚ö† Connection error: ' + e.message);
    });
});

function setLoadingMsg(msg) {
  document.getElementById('loading-msg').textContent = msg;
}

function refreshIfNeeded(collection) {
  if (!S.currentUser) return; // Not logged in yet, no need to refresh UI
  if (collection === 'bookings' && document.getElementById('panel-calendar').style.display !== 'none') {
    renderCalendar();
  }
  if ((collection === 'users' || collection === 'bookings' || collection === 'admins') && S.isAdmin) {
    renderAdminTab();
  }
}

// ‚îÄ‚îÄ‚îÄ Ensure default data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function ensureDefaultData() {
  const snap = await db.ref('admins').once('value');
  if (!snap.exists()) {
    // Seed default data
    await db.ref('admins').set({
      admin1: { username:'admin', password:'admin123', name:'System Administrator' }
    });
    await db.ref('users').set({
      user1: { id:'u1', name:'Alexandra Morgan',  department:'Executive',      role:'individual', email:'a.morgan@corp.com' },
      user2: { id:'u2', name:'James Whitfield',   department:'Finance',        role:'individual', email:'j.whitfield@corp.com' },
      user3: { id:'u3', name:'Sarah Chen',         department:'Marketing',      role:'individual', email:'s.chen@corp.com' },
      user4: { id:'u4', name:'David Okafor',       department:'Operations',     role:'individual', email:'d.okafor@corp.com' },
      user5: { id:'u5', name:'Priya Nair',         department:'Human Resources',role:'individual', email:'p.nair@corp.com' },
      user6: { id:'u6', name:'Finance Dept',       department:'Finance',        role:'dept',       email:'finance@corp.com' },
      user7: { id:'u7', name:'Marketing Dept',     department:'Marketing',      role:'dept',       email:'marketing@corp.com' },
    });
    await db.ref('bookings').set({});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PORTAL SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectPortal(type) {
  if (type === 'admin') {
    document.getElementById('admin-user').value = '';
    document.getElementById('admin-pass').value = '';
    document.getElementById('login-error').classList.remove('visible');
    showScreen('admin-login-screen');
  } else {
    renderUserList();
    showScreen('user-select-screen');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN LOGIN  ‚Üê Fix: admins array is now populated before this runs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doAdminLogin() {
  const u = document.getElementById('admin-user').value.trim();
  const p = document.getElementById('admin-pass').value.trim();
  const btn = document.getElementById('login-btn');

  const admin = S.admins.find(a => a.username === u && a.password === p);
  if (!admin) {
    document.getElementById('login-error').classList.add('visible');
    // shake
    const box = document.querySelector('#admin-login-screen .modal-box');
    box.style.transform = 'translateX(-8px)';
    setTimeout(() => box.style.transform = 'translateX(8px)', 80);
    setTimeout(() => box.style.transform = '', 160);
    return;
  }

  S.currentUser = {...admin, type:'admin'};
  S.isAdmin = true;
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER LIST  ‚Üê Fix: users array is now populated before this runs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUserList() {
  const el = document.getElementById('user-list');
  if (S.users.length === 0) {
    el.innerHTML = '<div class="empty-state"><p>No users found in system.</p></div>';
    return;
  }
  const depts = [...new Set(S.users.map(u => u.department))].sort();
  el.innerHTML = depts.map(dept => {
    const us = S.users.filter(u => u.department === dept);
    return `
      <div class="dept-group">
        <div class="dept-label">${dept}</div>
        ${us.map(u => `
          <div class="user-option" onclick="selectUser('${u._key}')">
            <div class="u-avatar">${initials(u.name)}</div>
            <div>
              <div class="u-name">${u.name}</div>
              <div class="u-dept">${u.role === 'dept' ? 'Department Account' : 'Individual'}</div>
            </div>
          </div>`).join('')}
      </div>`;
  }).join('');
}

function selectUser(key) {
  const user = S.users.find(u => u._key === key);
  if (!user) return;
  S.currentUser = {...user, type:'user'};
  S.isAdmin = false;
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  const u = S.currentUser;
  document.getElementById('sb-name').textContent = u.name;
  document.getElementById('sb-role').textContent = S.isAdmin ? 'Administrator' : (u.department || 'User');
  document.getElementById('sb-avatar').textContent = initials(u.name);
  if (S.isAdmin) {
    document.getElementById('sb-avatar').classList.add('admin-av');
    document.getElementById('nav-admin').style.display = 'flex';
  }

  // Populate booking form attendee dropdowns
  populateAttendeeDropdowns();

  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('app').classList.add('active');

  if (S.isAdmin) {
    switchPanel('admin');
  } else {
    switchPanel('calendar');
  }
  notify('Welcome, ' + u.name + ' ‚úì');
}

function doLogout() {
  S.currentUser = null;
  S.isAdmin = false;
  document.getElementById('app').classList.remove('active');
  document.getElementById('nav-admin').style.display = 'none';
  document.getElementById('sb-avatar').classList.remove('admin-av');
  showScreen('portal-screen');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PANEL SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPanel(panel) {
  document.getElementById('panel-calendar').style.display = panel === 'calendar' ? 'flex' : 'none';
  document.getElementById('panel-calendar').style.flexDirection = 'column';
  document.getElementById('panel-admin').style.display   = panel === 'admin'    ? 'flex' : 'none';
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (panel === 'calendar') {
    document.getElementById('nav-calendar').classList.add('active');
    renderCalendar();
  } else {
    document.getElementById('nav-admin').classList.add('active');
    renderAdminTab();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESOURCE / VIEW / NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchResource(r) {
  S.resource = r;
  document.getElementById('tab-boardroom').classList.toggle('active', r === 'boardroom');
  document.getElementById('tab-car').classList.toggle('active', r === 'car');
  renderCalendar();
}

function switchView(v) {
  S.view = v;
  document.querySelectorAll('.view-tab').forEach((btn,i) => {
    btn.classList.toggle('active', ['day','week','month','year'][i] === v);
  });
  renderCalendar();
}

function navPrev() {
  const d = new Date(S.date);
  if (S.view === 'day')   d.setDate(d.getDate()-1);
  else if (S.view === 'week') d.setDate(d.getDate()-7);
  else if (S.view === 'month') d.setMonth(d.getMonth()-1);
  else if (S.view === 'year') d.setFullYear(d.getFullYear()-1);
  S.date = d; renderCalendar();
}
function navNext() {
  const d = new Date(S.date);
  if (S.view === 'day')   d.setDate(d.getDate()+1);
  else if (S.view === 'week') d.setDate(d.getDate()-7+7);
  else if (S.view === 'month') d.setMonth(d.getMonth()+1);
  else if (S.view === 'year') d.setFullYear(d.getFullYear()+1);
  S.date = d; renderCalendar();
}
function goToday() { S.date = new Date(); renderCalendar(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CALENDAR RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS_SHORT  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS_FULL = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const HOUR_START = 6, HOUR_END = 22; // 6am‚Äì10pm
const PX_PER_HOUR = 64;
const resBkgs = {boardroom:'boardroom',car:'car'};

function renderCalendar() {
  const wrap = document.getElementById('calendar-wrap');
  const bks = S.bookings.filter(b => b.resource === S.resource);
  switch(S.view) {
    case 'day':   renderDayView(wrap, bks);   break;
    case 'week':  renderWeekView(wrap, bks);  break;
    case 'month': renderMonthView(wrap, bks); break;
    case 'year':  renderYearView(wrap, bks);  break;
  }
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toMin(t) { const [h,m]=t.split(':').map(Number); return h*60+m; }
function fromMin(m) { return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }
function dateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function isSameDay(a,b) { return dateStr(a)===dateStr(b); }
function startOfWeek(d) { const x=new Date(d); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; }
function addDays(d,n) { const x=new Date(d); x.setDate(x.getDate()+n); return x; }

function bksByDay(bks, dateS) {
  return bks.filter(b => b.date === dateS);
}

function bkTopPx(startTime) {
  return (toMin(startTime) - HOUR_START*60) * (PX_PER_HOUR/60);
}
function bkHeightPx(startTime, endTime) {
  return Math.max((toMin(endTime)-toMin(startTime)) * (PX_PER_HOUR/60), 22);
}

function totalGridH() { return (HOUR_END - HOUR_START) * PX_PER_HOUR; }

function renderTimeColumn() {
  let h = '<div style="flex-shrink:0;width:52px;">';
  for (let hr = HOUR_START; hr <= HOUR_END; hr++) {
    const label = hr === 12 ? '12pm' : hr < 12 ? `${hr}am` : `${hr-12}pm`;
    h += `<div style="height:${PX_PER_HOUR}px;display:flex;align-items:flex-start;justify-content:flex-end;padding:4px 8px 0 0;font-size:10px;color:var(--blue-grey);border-right:1px solid var(--grey);font-weight:500;">${label}</div>`;
  }
  h += '</div>';
  return h;
}

function renderDayCol(dateS, bks, clickable) {
  const today = dateStr(new Date());
  const dayBks = bksByDay(bks, dateS);
  let h = `<div style="flex:1;position:relative;min-width:80px;" class="${dateS===today?'today-col':''}">`;
  // grid lines
  for (let hr = HOUR_START; hr <= HOUR_END; hr++) {
    h += `<div style="height:${PX_PER_HOUR}px;border-bottom:1px solid var(--lt-beige);border-right:1px solid var(--lt-beige);" ${clickable?`onclick="openBookModal('${dateS}','${String(hr).padStart(2,'0')}:00')"`:''}></div>`;
  }
  // bookings
  dayBks.forEach(b => {
    const top = bkTopPx(b.startTime);
    const ht = bkHeightPx(b.startTime, b.endTime);
    h += `<div class="bk-chip ${b.resource}" style="top:${top}px;height:${ht}px;" onclick="event.stopPropagation();openDetail('${b._key}')">
      <div class="bk-title">${b.purpose}</div>
      ${ht>34?`<div class="bk-meta">${b.startTime}‚Äì${b.endTime} ¬∑ ${b.user||''}</div>`:''}
    </div>`;
  });
  h += '</div>';
  return h;
}

// ‚îÄ‚îÄ‚îÄ Day View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDayView(wrap, bks) {
  const d = S.date;
  document.getElementById('cal-title').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  const ds = dateStr(d);
  const today = dateStr(new Date());
  wrap.innerHTML = `
    <div class="time-grid fade-in">
      <div class="tg-header" style="grid-template-columns:52px 1fr;">
        <div class="th-time"></div>
        <div class="th-day ${ds===today?'th-day-today':''}">
          <div>${DAYS_SHORT[d.getDay()]}</div>
          <div class="th-day-num">${d.getDate()}</div>
          ${ds===today?'<div class="th-today-dot"></div>':''}
        </div>
      </div>
      <div style="display:flex;overflow-y:auto;max-height:calc(100vh - 200px);">
        ${renderTimeColumn()}
        ${renderDayCol(ds,bks,true)}
      </div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ Week View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeekView(wrap, bks) {
  const ws = startOfWeek(S.date);
  const we = addDays(ws, 6);
  const today = dateStr(new Date());
  const fmtR = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  document.getElementById('cal-title').textContent = `${fmtR(ws)} ‚Äì ${fmtR(we)}, ${we.getFullYear()}`;

  const days = Array.from({length:7},(_,i)=>addDays(ws,i));
  const cols = '52px ' + days.map(()=>'1fr').join(' ');

  let hdrHtml = `<div class="th-time" style="border-right:1px solid rgba(255,255,255,.08);"></div>`;
  days.forEach(d => {
    const ds = dateStr(d);
    const isT = ds===today;
    hdrHtml += `<div class="th-day ${isT?'th-day-today':''}" style="border-right:1px solid rgba(255,255,255,.08);">
      <div>${DAYS_SHORT[d.getDay()]}</div>
      <div class="th-day-num">${d.getDate()}</div>
      ${isT?'<div class="th-today-dot"></div>':''}
    </div>`;
  });

  let bodyHtml = `<div style="display:flex;overflow-y:auto;max-height:calc(100vh - 200px);">
    ${renderTimeColumn()}
    ${days.map(d => renderDayCol(dateStr(d), bks, true)).join('')}
  </div>`;

  wrap.innerHTML = `<div class="time-grid fade-in">
    <div class="tg-header" style="grid-template-columns:${cols};">${hdrHtml}</div>
    ${bodyHtml}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ Month View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMonthView(wrap, bks) {
  const d = S.date;
  document.getElementById('cal-title').textContent = `${MONTHS_FULL[d.getMonth()]} ${d.getFullYear()}`;
  const today = dateStr(new Date());
  const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
  const startPad = firstDay.getDay();
  const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();

  const cells = [];
  for(let i=0;i<startPad;i++) cells.push({day:null,ds:null});
  for(let i=1;i<=daysInMonth;i++){
    const cd = new Date(d.getFullYear(),d.getMonth(),i);
    cells.push({day:i, ds:dateStr(cd)});
  }
  while(cells.length%7!==0) cells.push({day:null,ds:null});

  const bodyHtml = cells.map(c => {
    if(!c.day) return `<div class="month-cell other-month"></div>`;
    const isT = c.ds===today;
    const dayBks = bksByDay(bks, c.ds);
    const chips = dayBks.slice(0,3).map(b => `
      <div class="mc-chip ${b.resource}" onclick="event.stopPropagation();openDetail('${b._key}')">${b.purpose}</div>`).join('');
    const more = dayBks.length > 3 ? `<div class="mc-more">+${dayBks.length-3} more</div>` : '';
    return `<div class="month-cell ${isT?'today':''}" onclick="S.date=new Date('${c.ds}T12:00:00');switchView('day');">
      <div class="mc-num ${isT?'today-num':''}">${c.day}</div>
      ${chips}${more}
    </div>`;
  }).join('');

  wrap.innerHTML = `<div class="month-grid fade-in">
    <div class="month-header-row">${DAYS_SHORT.map(d=>`<div class="mhc">${d}</div>`).join('')}</div>
    <div class="month-body">${bodyHtml}</div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ Year View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderYearView(wrap, bks) {
  const yr = S.date.getFullYear();
  document.getElementById('cal-title').textContent = yr;
  const today = new Date();

  const cards = MONTHS_FULL.map((mn, mi) => {
    const first = new Date(yr, mi, 1);
    const dim = new Date(yr, mi+1, 0).getDate();
    const pad = first.getDay();
    const bksInMonth = bks.filter(b => {
      const bd = new Date(b.date+'T12:00:00');
      return bd.getFullYear()===yr && bd.getMonth()===mi;
    });

    const cells = [];
    for(let i=0;i<pad;i++) cells.push('');
    for(let d=1;d<=dim;d++) cells.push(d);

    const daysHtml = cells.map(d => {
      if(!d) return '<div class="mini-day"></div>';
      const ds = `${yr}-${String(mi+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const hasB = bksInMonth.some(b=>b.date===ds);
      const isT  = isSameDay(new Date(ds+'T12:00:00'), today);
      return `<div class="mini-day ${isT?'today-mini':hasB?'has-bk':''}">${d}</div>`;
    }).join('');

    return `<div class="mini-cal" onclick="S.date=new Date(${yr},${mi},1);switchView('month');">
      <div class="mini-cal-hdr">
        ${mn} ${yr}
        ${bksInMonth.length?`<span class="bk-count">${bksInMonth.length}</span>`:''}
      </div>
      <div class="mini-cal-body">
        <div class="mini-days-hdr">${'SMTWTFS'.split('').map(x=>`<span>${x}</span>`).join('')}</div>
        <div class="mini-days-body">${daysHtml}</div>
      </div>
    </div>`;
  }).join('');

  wrap.innerHTML = `<div class="year-grid fade-in">${cards}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOKING MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBookModal(prefillDate, prefillTime) {
  S.bkResource = S.resource;
  S.bkAs = 'self';
  S.bkAttendees = [];
  S.bkRecurrence = 'once';
  S.bkStartMin = prefillTime ? toMin(prefillTime) : 540;
  S.bkEndMin   = S.bkStartMin + 60;

  setBkResource(S.bkResource);
  setBkAs('self');
  setRecurrence('once');
  document.getElementById('bk-purpose').value = '';
  document.getElementById('bk-notes').value   = '';
  document.getElementById('bk-date').value    = prefillDate || dateStr(S.date);
  document.getElementById('bk-conflict').classList.remove('visible');
  document.getElementById('bk-error').classList.remove('visible');
  document.getElementById('rec-count-wrap').style.display = 'none';
  renderAttendeeTags();
  updateDials();
  openModal('modal-book');
}

function setBkResource(r) {
  S.bkResource = r;
  document.getElementById('bk-res-boardroom').classList.toggle('active', r==='boardroom');
  document.getElementById('bk-res-car').classList.toggle('active', r==='car');
  checkConflict();
}
function setBkAs(a) {
  S.bkAs = a;
  document.getElementById('bk-as-self').classList.toggle('active', a==='self');
  document.getElementById('bk-as-dept').classList.toggle('active', a==='dept');
}

function adjustTime(which, delta) {
  if (which==='start') {
    S.bkStartMin = Math.max(HOUR_START*60, Math.min(HOUR_END*60-30, S.bkStartMin+delta));
    if (S.bkEndMin <= S.bkStartMin) S.bkEndMin = S.bkStartMin + 30;
  } else {
    S.bkEndMin = Math.max(S.bkStartMin+30, Math.min(HOUR_END*60, S.bkEndMin+delta));
  }
  updateDials();
  checkConflict();
}
function updateDials() {
  document.getElementById('dial-start').textContent = fromMin(S.bkStartMin);
  document.getElementById('dial-end').textContent   = fromMin(S.bkEndMin);
}

function setRecurrence(r) {
  S.bkRecurrence = r;
  ['once','daily','weekdays','weekly','monthly'].forEach(v => {
    document.getElementById('rec-'+v).classList.toggle('active',v===r);
  });
  document.getElementById('rec-count-wrap').style.display = r==='once' ? 'none' : 'flex';
}

function populateAttendeeDropdowns() {
  const uSel = document.getElementById('att-user-sel');
  const dSel = document.getElementById('att-dept-sel');
  uSel.innerHTML = '<option value="">Add a person‚Ä¶</option>' +
    S.users.map(u => `<option value="${u.name}">${u.name} (${u.department})</option>`).join('');
  const depts = [...new Set(S.users.map(u=>u.department))].sort();
  dSel.innerHTML = '<option value="">Add a department‚Ä¶</option>' +
    depts.map(d => `<option value="${d}">${d}</option>`).join('');
}

function addAttendeeFromUser() {
  const v = document.getElementById('att-user-sel').value;
  if (v && !S.bkAttendees.includes(v)) { S.bkAttendees.push(v); renderAttendeeTags(); }
  document.getElementById('att-user-sel').value = '';
}
function addAttendeeFromDept() {
  const dept = document.getElementById('att-dept-sel').value;
  if (!dept) return;
  S.users.filter(u=>u.department===dept).forEach(u => {
    if (!S.bkAttendees.includes(u.name)) S.bkAttendees.push(u.name);
  });
  renderAttendeeTags();
  document.getElementById('att-dept-sel').value = '';
}
function removeAttendee(name) {
  S.bkAttendees = S.bkAttendees.filter(a=>a!==name);
  renderAttendeeTags();
}
function renderAttendeeTags() {
  document.getElementById('attendees-wrap').innerHTML = S.bkAttendees.map(a =>
    `<div class="att-tag">${a}<button onclick="removeAttendee('${a.replace(/'/g,"\\'")}')">√ó</button></div>`
  ).join('');
}

function checkConflict() {
  const date = document.getElementById('bk-date').value;
  if (!date) return;
  const st = fromMin(S.bkStartMin);
  const et = fromMin(S.bkEndMin);
  const conflict = S.bookings.some(b =>
    b.resource === S.bkResource && b.date === date &&
    toMin(b.startTime) < toMin(et) && toMin(b.endTime) > toMin(st)
  );
  document.getElementById('bk-conflict').classList.toggle('visible', conflict);
}

// Generate dates for recurrence
function buildRecurrenceDates(baseDate, type, count) {
  const dates = [];
  const d = new Date(baseDate+'T12:00:00');
  if (type === 'once') return [baseDate];
  const n = Math.max(2, parseInt(count)||4);
  if (type === 'daily') {
    for(let i=0;i<n;i++) dates.push(dateStr(addDays(d,i)));
  } else if (type === 'weekdays') {
    let cur = new Date(d), added=0;
    while(added<n) {
      if(cur.getDay()!==0&&cur.getDay()!==6){dates.push(dateStr(cur));added++;}
      cur=addDays(cur,1);
    }
  } else if (type === 'weekly') {
    for(let i=0;i<n;i++) dates.push(dateStr(addDays(d,i*7)));
  } else if (type === 'monthly') {
    for(let i=0;i<n;i++){
      const x=new Date(d); x.setMonth(x.getMonth()+i);
      dates.push(dateStr(x));
    }
  }
  return dates;
}

async function saveBooking() {
  const purpose = document.getElementById('bk-purpose').value.trim();
  const date    = document.getElementById('bk-date').value;
  if (!purpose) { showBkError('Please enter a title or purpose.'); return; }
  if (!date)    { showBkError('Please select a date.'); return; }

  const startT = fromMin(S.bkStartMin);
  const endT   = fromMin(S.bkEndMin);

  const conflict = S.bookings.some(b =>
    b.resource === S.bkResource && b.date === date &&
    toMin(b.startTime) < toMin(endT) && toMin(b.endTime) > toMin(startT)
  );
  if (conflict) { showBkError('Time slot conflicts with an existing booking. Please choose another time.'); return; }

  const btn = document.getElementById('bk-submit-btn');
  btn.textContent = 'Saving‚Ä¶'; btn.disabled = true;

  const groupId = uid();
  const count = document.getElementById('rec-count').value;
  const dates = buildRecurrenceDates(date, S.bkRecurrence, count);

  try {
    for (const d of dates) {
      const bk = {
        id: uid(),
        resource: S.bkResource,
        date: d,
        startTime: startT,
        endTime: endT,
        user: S.currentUser.name,
        userId: S.currentUser.id || S.currentUser._key,
        department: S.currentUser.department || '',
        bookedAs: S.bkAs,
        purpose,
        attendees: S.bkAttendees.join(', '),
        notes: document.getElementById('bk-notes').value.trim(),
        groupId: dates.length > 1 ? groupId : null,
        createdAt: new Date().toISOString()
      };
      await db.ref('bookings/' + bk.id).set(bk);
    }
    closeModal('modal-book');
    notify(dates.length > 1 ? `${dates.length} recurring bookings saved ‚úì` : 'Booking confirmed ‚úì');
  } catch(e) {
    showBkError('Failed to save: ' + e.message);
  } finally {
    btn.textContent = 'Confirm Booking'; btn.disabled = false;
  }
}

function showBkError(msg) {
  const el = document.getElementById('bk-error');
  el.textContent = msg;
  el.classList.add('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOKING DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(key) {
  const b = S.bookings.find(x => x._key === key);
  if (!b) return;
  const canManage = S.isAdmin || b.userId === (S.currentUser.id||S.currentUser._key) || b.user === S.currentUser.name;
  const resLabel = b.resource === 'boardroom' ? 'Board Room' : 'Company Car';

  document.getElementById('detail-hdr').className = `detail-res-hdr ${b.resource}`;
  document.getElementById('detail-resource-label').textContent = resLabel;
  document.getElementById('detail-title').textContent = b.purpose;

  const dateObj = new Date(b.date+'T12:00:00');
  document.getElementById('detail-info-grid').innerHTML = `
    <div class="info-card"><div class="ic-label">Date</div><div class="ic-val">${dateObj.toLocaleDateString('en-US',{weekday:'short',month:'long',day:'numeric'})}</div></div>
    <div class="info-card"><div class="ic-label">Time</div><div class="ic-val">${b.startTime} ‚Äì ${b.endTime}</div></div>
    <div class="info-card"><div class="ic-label">Booked By</div><div class="ic-val">${b.user||'‚Äî'}</div></div>
    <div class="info-card"><div class="ic-label">Booked As</div><div class="ic-val">${b.bookedAs==='dept'?'Department':'Individual'}</div></div>
  `;

  const attWrap = document.getElementById('detail-attendees-wrap');
  if (b.attendees) {
    attWrap.style.display = 'block';
    document.getElementById('detail-attendees').innerHTML = b.attendees.split(',').filter(Boolean).map(a =>
      `<div class="att-tag" style="background:rgba(0,69,81,.1);color:var(--teal);">${a.trim()}</div>`
    ).join('');
  } else { attWrap.style.display = 'none'; }

  const notesEl = document.getElementById('detail-notes');
  if (b.notes) { notesEl.style.display='block'; notesEl.textContent = b.notes; }
  else { notesEl.style.display='none'; }

  const actEl = document.getElementById('detail-actions');
  if (canManage) {
    actEl.innerHTML = `
      ${S.isAdmin ? `<button class="btn-prim teal" onclick="openMoveModal('${key}');closeModal('modal-detail');">Move</button>` : ''}
      ${S.isAdmin ? `<button class="btn-prim plum" onclick="openSwapModal('${key}');closeModal('modal-detail');">Swap</button>` : ''}
      <button class="btn-sec" style="flex:1;background:rgba(192,57,43,.08);border-color:rgba(192,57,43,.25);color:var(--danger);" onclick="deleteBooking('${key}')">Remove</button>
    `;
  } else { actEl.innerHTML = ''; }

  openModal('modal-detail');
}

async function deleteBooking(key) {
  if (!confirm('Remove this booking?')) return;
  try {
    await db.ref('bookings/'+key).remove();
    closeModal('modal-detail');
    notify('Booking removed ‚úì');
  } catch(e) { alert('Failed: '+e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOVE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMoveModal(key) {
  const b = S.bookings.find(x=>x._key===key);
  if (!b) return;
  S.moveTarget = key;
  document.getElementById('move-booking-info').innerHTML = `
    <div class="ic-label">Moving:</div>
    <div class="ic-val">${b.purpose} ‚Äî ${b.date} ${b.startTime}‚Äì${b.endTime}</div>`;
  document.getElementById('move-date').value  = b.date;
  document.getElementById('move-start').value = b.startTime;
  document.getElementById('move-end').value   = b.endTime;
  openModal('modal-move');
}
async function confirmMove() {
  const newDate  = document.getElementById('move-date').value;
  const newStart = document.getElementById('move-start').value;
  const newEnd   = document.getElementById('move-end').value;
  if (!newDate||!newStart||!newEnd) return;
  if (toMin(newEnd)<=toMin(newStart)) { alert('End time must be after start time.'); return; }
  try {
    await db.ref('bookings/'+S.moveTarget).update({date:newDate,startTime:newStart,endTime:newEnd});
    closeModal('modal-move');
    notify('Booking moved ‚úì');
  } catch(e) { alert('Failed: '+e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SWAP MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSwapModal(key) {
  const b = S.bookings.find(x=>x._key===key);
  if (!b) return;
  S.swapTarget = key;
  document.getElementById('swap-a-info').innerHTML = `
    <div class="ic-val">${b.purpose} ‚Äî ${b.date} ${b.startTime}‚Äì${b.endTime}</div>`;
  const others = S.bookings.filter(x=>x._key!==key && x.resource===b.resource);
  document.getElementById('swap-b-sel').innerHTML =
    '<option value="">Select a booking‚Ä¶</option>' +
    others.map(x=>`<option value="${x._key}">${x.purpose} ‚Äî ${x.date} ${x.startTime}‚Äì${x.endTime}</option>`).join('');
  openModal('modal-swap');
}
async function confirmSwap() {
  const bKey = document.getElementById('swap-b-sel').value;
  if (!bKey) { alert('Please select a booking to swap with.'); return; }
  const a = S.bookings.find(x=>x._key===S.swapTarget);
  const b = S.bookings.find(x=>x._key===bKey);
  if (!a||!b) return;
  try {
    await db.ref('bookings/'+S.swapTarget).update({date:b.date,startTime:b.startTime,endTime:b.endTime});
    await db.ref('bookings/'+bKey).update({date:a.date,startTime:a.startTime,endTime:a.endTime});
    closeModal('modal-swap');
    notify('Bookings swapped ‚úì');
  } catch(e) { alert('Failed: '+e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAdminTab(tab) {
  S.adminTab = tab;
  document.querySelectorAll('.admin-tab').forEach((t,i) => {
    t.classList.toggle('active', ['bookings','users','admins'][i]===tab);
  });
  renderAdminTab();
}

function renderAdminTab() {
  const el = document.getElementById('admin-body');
  if (S.adminTab === 'bookings') el.innerHTML = renderAdminBookings();
  else if (S.adminTab === 'users') el.innerHTML = renderAdminUsers();
  else if (S.adminTab === 'admins') el.innerHTML = renderAdminAdmins();
}

function renderAdminBookings() {
  const sorted = [...S.bookings].sort((a,b)=>a.date>b.date?-1:1);
  const rows = sorted.map(b => `
    <tr>
      <td><span class="badge ${b.resource==='boardroom'?'badge-teal':'badge-plum'}">${b.resource==='boardroom'?'Board Room':'Car'}</span></td>
      <td>${b.date}</td>
      <td>${b.startTime} ‚Äì ${b.endTime}</td>
      <td><strong>${b.purpose}</strong></td>
      <td>${b.user||'‚Äî'}</td>
      <td>
        <div class="action-btns">
          <button class="btn-sm btn-move" onclick="openMoveModal('${b._key}')">Move</button>
          <button class="btn-sm btn-swap" onclick="openSwapModal('${b._key}')">Swap</button>
          <button class="btn-sm btn-del" onclick="adminDeleteBooking('${b._key}')">Delete</button>
        </div>
      </td>
    </tr>`).join('');
  return `
    <div class="section-hdr">
      <h3>All Bookings (${S.bookings.length})</h3>
      <button class="btn-book" onclick="openBookModal(null,null)">Ôºã New Booking</button>
    </div>
    <div class="data-table">
      <table><thead><tr><th>Resource</th><th>Date</th><th>Time</th><th>Purpose</th><th>Booked By</th><th>Actions</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="6" style="text-align:center;color:var(--blue-grey);padding:40px;">No bookings yet</td></tr>'}</tbody>
      </table>
    </div>`;
}

function renderAdminUsers() {
  const rows = S.users.map(u => `
    <tr>
      <td>${u.name}</td>
      <td>${u.department||'‚Äî'}</td>
      <td><span class="badge ${u.role==='dept'?'badge-teal':'badge-gold'}">${u.role==='dept'?'Department':'Individual'}</span></td>
      <td>${u.email||'‚Äî'}</td>
      <td>
        <div class="action-btns">
          <button class="btn-sm btn-edit" onclick="editUser('${u._key}')">Edit</button>
          <button class="btn-sm btn-del" onclick="adminDeleteUser('${u._key}')">Delete</button>
        </div>
      </td>
    </tr>`).join('');
  return `
    <div class="section-hdr">
      <h3>Users (${S.users.length})</h3>
      <button class="btn-book" onclick="openAddUserModal()">Ôºã Add User</button>
    </div>
    <div class="data-table">
      <table><thead><tr><th>Name</th><th>Department</th><th>Type</th><th>Email</th><th>Actions</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>`;
}

function renderAdminAdmins() {
  const rows = S.admins.map(a => `
    <tr>
      <td><strong>${a.name}</strong></td>
      <td>${a.username}</td>
      <td>
        <div class="action-btns">
          <button class="btn-sm btn-edit" onclick="editAdminEntry('${a._key}')">Edit</button>
          <button class="btn-sm btn-del" onclick="adminDeleteAdmin('${a._key}')">Delete</button>
        </div>
      </td>
    </tr>`).join('');
  return `
    <div class="section-hdr">
      <h3>Admin Accounts (${S.admins.length})</h3>
      <button class="btn-book" onclick="openAddAdminModal()">Ôºã Add Admin</button>
    </div>
    <div class="data-table">
      <table><thead><tr><th>Name</th><th>Username</th><th>Actions</th></tr></thead>
      <tbody>${rows}</tbody></table>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ Admin CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function adminDeleteBooking(key) {
  if (!confirm('Delete this booking?')) return;
  await db.ref('bookings/'+key).remove();
  notify('Booking deleted ‚úì');
}

function openAddUserModal() {
  document.getElementById('add-user-title').textContent = 'Add New User';
  document.getElementById('edit-user-key').value = '';
  document.getElementById('user-name').value = '';
  document.getElementById('user-email').value = '';
  document.getElementById('user-dept').value = '';
  document.getElementById('user-role').value = 'individual';
  openModal('modal-add-user');
}
function editUser(key) {
  const u = S.users.find(x=>x._key===key);
  if (!u) return;
  document.getElementById('add-user-title').textContent = 'Edit User';
  document.getElementById('edit-user-key').value = key;
  document.getElementById('user-name').value  = u.name;
  document.getElementById('user-email').value = u.email||'';
  document.getElementById('user-dept').value  = u.department||'';
  document.getElementById('user-role').value  = u.role||'individual';
  openModal('modal-add-user');
}
async function saveUser() {
  const key   = document.getElementById('edit-user-key').value;
  const name  = document.getElementById('user-name').value.trim();
  const email = document.getElementById('user-email').value.trim();
  const dept  = document.getElementById('user-dept').value.trim();
  const role  = document.getElementById('user-role').value;
  if (!name) { alert('Name is required.'); return; }
  const data  = { name, email, department:dept, role, id: key ? undefined : uid() };
  if (!data.id) delete data.id;
  if (key) {
    await db.ref('users/'+key).update(data);
  } else {
    data.id = uid();
    await db.ref('users/user_'+data.id).set(data);
  }
  populateAttendeeDropdowns();
  closeModal('modal-add-user');
  notify('User saved ‚úì');
}
async function adminDeleteUser(key) {
  if (!confirm('Delete this user?')) return;
  await db.ref('users/'+key).remove();
  notify('User deleted ‚úì');
}

function openAddAdminModal() {
  document.getElementById('add-admin-title').textContent = 'Add Admin User';
  document.getElementById('edit-admin-key').value = '';
  document.getElementById('admin-name-input').value = '';
  document.getElementById('admin-username-input').value = '';
  document.getElementById('admin-password-input').value = '';
  openModal('modal-add-admin');
}
function editAdminEntry(key) {
  const a = S.admins.find(x=>x._key===key);
  if (!a) return;
  document.getElementById('add-admin-title').textContent = 'Edit Admin';
  document.getElementById('edit-admin-key').value = key;
  document.getElementById('admin-name-input').value = a.name;
  document.getElementById('admin-username-input').value = a.username;
  document.getElementById('admin-password-input').value = a.password||'';
  openModal('modal-add-admin');
}
async function saveAdmin() {
  const key  = document.getElementById('edit-admin-key').value;
  const name = document.getElementById('admin-name-input').value.trim();
  const uname= document.getElementById('admin-username-input').value.trim();
  const pass = document.getElementById('admin-password-input').value.trim();
  if (!name||!uname||!pass) { alert('All fields required.'); return; }
  const data = {name, username:uname, password:pass};
  if (key) { await db.ref('admins/'+key).update(data); }
  else { await db.ref('admins/'+uname).set(data); }
  closeModal('modal-add-admin');
  notify('Admin saved ‚úì');
}
async function adminDeleteAdmin(key) {
  if (S.admins.length <= 1) { alert('Cannot delete the last admin account.'); return; }
  if (!confirm('Delete this admin?')) return;
  await db.ref('admins/'+key).remove();
  notify('Admin deleted ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key==='Escape') document.querySelectorAll('.overlay.open').forEach(o=>o.classList.remove('open')); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifTimer;
function notify(msg) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(notifTimer);
  notifTimer = setTimeout(()=>el.classList.remove('show'), 3200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initials(name) {
  return (name||'?').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
}
function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
</script>
</body>
</html>
